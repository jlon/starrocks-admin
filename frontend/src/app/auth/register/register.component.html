<nb-layout>
  <nb-layout-column>
    <div class="auth-container">
      <nb-card>
        <nb-card-header>
          <div class="logo-container">
            <div class="logo">
              <nb-icon icon="person-add-outline" status="success"></nb-icon>
            </div>
            <h1 class="title">StarRocks Admin</h1>
            <small class="sub-title">Create a new account</small>
          </div>
        </nb-card-header>

        <nb-card-body>
          <!-- Alert Messages -->
          <nb-alert *ngFor="let error of errors" status="danger" closable (close)="errors = []">
            {{ error }}
          </nb-alert>
          <nb-alert *ngFor="let message of messages" status="success" closable (close)="messages = []">
            {{ message }}
          </nb-alert>

          <form (ngSubmit)="register()" #form="ngForm">
            <!-- Username -->
            <div class="form-control-group">
              <label class="label" for="input-username">Username:</label>
              <input 
                nbInput
                fullWidth
                [(ngModel)]="user.username"
                #username="ngModel"
                id="input-username"
                name="username"
                placeholder="Username"
                autofocus
                [status]="username.dirty ? (username.invalid  ? 'danger' : 'success') : 'basic'"
                [required]="true"
                [minlength]="3"
                [attr.aria-invalid]="username.invalid && username.touched ? true : null">
              <ng-container *ngIf="username.invalid && username.touched">
                <p class="caption status-danger" *ngIf="username.errors?.['required']">
                  Username is required!
                </p>
                <p class="caption status-danger" *ngIf="username.errors?.['minlength']">
                  Username must be at least 3 characters!
                </p>
              </ng-container>
            </div>

            <!-- Email -->
            <div class="form-control-group">
              <label class="label" for="input-email">Email:</label>
              <input 
                nbInput
                fullWidth
                [(ngModel)]="user.email"
                #email="ngModel"
                type="email"
                id="input-email"
                name="email"
                placeholder="Email"
                [status]="email.dirty ? (email.invalid  ? 'danger' : 'success') : 'basic'"
                [required]="true"
                pattern="^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$"
                [attr.aria-invalid]="email.invalid && email.touched ? true : null">
              <ng-container *ngIf="email.invalid && email.touched">
                <p class="caption status-danger" *ngIf="email.errors?.['required']">
                  Email is required!
                </p>
                <p class="caption status-danger" *ngIf="email.errors?.['pattern']">
                  Email should be valid!
                </p>
              </ng-container>
            </div>

            <!-- Password -->
            <div class="form-control-group">
              <label class="label" for="input-password">Password:</label>
              <input 
                nbInput
                fullWidth
                [(ngModel)]="user.password"
                #password="ngModel"
                type="password"
                id="input-password"
                name="password"
                placeholder="Password"
                [status]="password.dirty ? (password.invalid  ? 'danger' : 'success') : 'basic'"
                [required]="true"
                [minlength]="6"
                [attr.aria-invalid]="password.invalid && password.touched ? true : null">
              <ng-container *ngIf="password.invalid && password.touched">
                <p class="caption status-danger" *ngIf="password.errors?.['required']">
                  Password is required!
                </p>
                <p class="caption status-danger" *ngIf="password.errors?.['minlength']">
                  Password must be at least 6 characters!
                </p>
              </ng-container>
            </div>

            <!-- Confirm Password -->
            <div class="form-control-group">
              <label class="label" for="input-confirm-password">Confirm Password:</label>
              <input 
                nbInput
                fullWidth
                [(ngModel)]="user.confirmPassword"
                #confirmPassword="ngModel"
                type="password"
                id="input-confirm-password"
                name="confirmPassword"
                placeholder="Confirm Password"
                [status]="confirmPassword.dirty ? (confirmPassword.invalid  ? 'danger' : 'success') : 'basic'"
                [required]="true"
                [attr.aria-invalid]="confirmPassword.invalid && confirmPassword.touched ? true : null">
              <ng-container *ngIf="confirmPassword.invalid && confirmPassword.touched">
                <p class="caption status-danger" *ngIf="confirmPassword.errors?.['required']">
                  Confirmation is required!
                </p>
              </ng-container>
              <ng-container *ngIf="user.password !== user.confirmPassword && confirmPassword.touched">
                <p class="caption status-danger">
                  Passwords do not match!
                </p>
              </ng-container>
            </div>

            <!-- Avatar Selection -->
            <div class="form-control-group">
              <label class="label">选择您的头像</label>
              <p class="subtitle">这将是您在平台上的个人标识</p>
              
              <!-- Current Avatar Preview -->
              <div class="avatar-preview-section">
                <div class="current-avatar-large">
                  <img *ngIf="user.avatar" [src]="user.avatar" [alt]="'Selected Avatar'" class="preview-image">
                  <div *ngIf="!user.avatar" class="avatar-placeholder-large">
                    <nb-icon icon="person-outline"></nb-icon>
                  </div>
                </div>
              </div>

              <!-- Avatar Options Grid -->
              <div class="avatar-options-grid">
                <div 
                  *ngFor="let avatar of availableAvatars; let i = index" 
                  class="avatar-option-small"
                  [class.selected]="user.avatar === avatar"
                  (click)="selectAvatar(avatar)">
                  <img [src]="avatar" [alt]="'Avatar Option'" class="option-image">
                </div>
              </div>

              <!-- Refresh Button -->
              <div class="refresh-section">
                <button 
                  type="button" 
                  nbButton 
                  status="primary" 
                  size="medium"
                  (click)="generateAvatarOptions()">
                  <nb-icon icon="refresh-outline"></nb-icon>
                  换一批
                </button>
              </div>
            </div>

            <!-- Submit Button -->
            <button 
              nbButton 
              fullWidth
              status="success"
              size="large"
              [disabled]="submitted || !form.valid"
              [class.btn-pulse]="submitted">
              <nb-icon *ngIf="submitted" icon="loader-outline" [options]="{animation: {type: 'pulse'}}"></nb-icon>
              <span *ngIf="!submitted">Register</span>
              <span *ngIf="submitted">Creating account...</span>
            </button>
          </form>

          <!-- Login Link -->
          <section class="another-action" aria-label="Login">
            Already have an account? <a class="text-link" routerLink="../login">Login</a>
          </section>
        </nb-card-body>
      </nb-card>
    </div>
  </nb-layout-column>
</nb-layout>
