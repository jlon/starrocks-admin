<div class="row" *ngIf="!loading && cluster">
  <div class="col-12">
    <nb-card>
      <nb-card-header class="border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-4">
            <div class="icon-container bg-primary-light text-primary">
              <nb-icon icon="cube"></nb-icon>
            </div>
            <div class="d-flex flex-column justify-content-center">
              <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">{{ cluster?.name }}</h5>
                <nb-tag *ngIf="health?.status" [text]="health?.status" [status]="health?.status === 'healthy' ? 'success' : 'warning'" size="tiny" appearance="filled"></nb-tag>
              </div>
              <span class="text-hint caption-2 mt-1">ID: {{ cluster?.id }}</span>
            </div>
          </div>
          <div class="actions d-flex gap-2">
            <button nbButton ghost status="info" (click)="editCluster()" [nbTooltip]="'common.edit' | translate">
              <nb-icon icon="settings-2-outline"></nb-icon>
            </button>
            <button nbButton ghost status="danger" (click)="deleteCluster()" [nbTooltip]="'cluster.delete_cluster' | translate">
              <nb-icon icon="trash-2-outline"></nb-icon>
            </button>
            <button nbButton ghost status="primary" [nbTooltip]="'cluster.view_configure_info' | translate" (click)="openConfigureDialog(configDialog)">
              <nb-icon icon="file-text-outline"></nb-icon>
            </button>
          </div>
        </div>
      </nb-card-header>

      <nb-card-body class="p-4">
        <div class="row g-4">
          <!-- 基本信息列 -->
          <div class="col-md-7 col-lg-8 border-end-md">
            <h6 class="section-title mb-3">
              <nb-icon icon="info-outline" class="me-2 text-hint"></nb-icon>
              {{ 'cluster.basic_info' | translate }}
            </h6>
            
            <div class="info-grid">
              <div class="info-item">
                <span class="label">{{ 'common.description' | translate }}</span>
                <span class="value">{{ cluster?.description || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'cluster.fe_address' | translate }}</span>
                <span class="value font-monospace">{{ cluster?.fe_host }}:{{ cluster?.fe_http_port }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'cluster.query_port' | translate }}</span>
                <span class="value font-monospace">{{ cluster?.fe_query_port }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'cluster.connection_user' | translate }}</span>
                <span class="value">{{ cluster?.username }}</span>
              </div>
              <div class="info-item">
                <span class="label">Catalog</span>
                <span class="value">{{ cluster?.catalog || 'default_catalog' }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'cluster.created_at' | translate }}</span>
                <span class="value">{{ cluster?.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
              </div>
            </div>

            <div class="mt-5">
              <h6 class="section-title mb-3">
                <nb-icon icon="compass-outline" class="me-2 text-hint"></nb-icon>
                {{ 'cluster.quick_navigation' | translate }}
              </h6>
              <div class="row g-3">
                <div class="col-6 col-sm-4 col-xl-3">
                  <div class="nav-card" (click)="navigateTo('backends')">
                    <nb-icon icon="hard-drive-outline" status="info"></nb-icon>
                    <span>{{ 'cluster.compute_nodes' | translate }}</span>
                  </div>
                </div>
                <div class="col-6 col-sm-4 col-xl-3">
                  <div class="nav-card" (click)="navigateTo('frontends')">
                    <nb-icon icon="browser-outline" status="primary"></nb-icon>
                    <span>{{ 'cluster.frontend_nodes' | translate }}</span>
                  </div>
                </div>
                <div class="col-6 col-sm-4 col-xl-3">
                  <div class="nav-card" (click)="navigateTo('queries')">
                    <nb-icon icon="activity-outline" status="warning"></nb-icon>
                    <span>{{ 'cluster.query_management' | translate }}</span>
                  </div>
                </div>
                <div class="col-6 col-sm-4 col-xl-3">
                  <div class="nav-card" (click)="navigateTo('monitor')">
                    <nb-icon icon="pie-chart-outline" status="success"></nb-icon>
                    <span>{{ 'cluster.monitoring_metrics' | translate }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 健康检查列 -->
          <div class="col-md-5 col-lg-4 ps-md-4">
            <h6 class="section-title mb-3">
              <nb-icon icon="activity-outline" class="me-2 text-hint"></nb-icon>
              {{ 'cluster.health_check' | translate }}
            </h6>
            
            <div class="health-timeline" *ngIf="health">
              <div *ngFor="let check of health.checks" class="timeline-item">
                <div class="timeline-marker" [class.status-success]="check.status === 'ok'" [class.status-danger]="check.status !== 'ok'"></div>
                <div class="timeline-content">
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="check-name">{{ check.name }}</span>
                    <nb-icon [icon]="check.status === 'ok' ? 'checkmark-circle-2' : 'alert-circle'" 
                             [status]="check.status === 'ok' ? 'success' : 'danger'" 
                             class="check-icon"></nb-icon>
                  </div>
                  <p class="check-message text-hint caption mt-1">{{ check.message }}</p>
                </div>
              </div>
            </div>
            
            <div *ngIf="!health" class="text-center py-4 text-hint">
              <nb-spinner size="small" status="basic" class="mb-2"></nb-spinner>
              <div class="caption">{{ 'cluster.checking_health_status' | translate }}</div>
            </div>
          </div>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<ng-template #configDialog let-dialogRef="dialogRef">
  <nb-card class="config-dialog">
    <nb-card-header class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <nb-icon icon="settings-2-outline" status="primary"></nb-icon>
        <span>{{ 'cluster.fe_configure_info' | translate }}</span>
        <span class="text-hint caption" *ngIf="!configLoading">({{ filteredConfigureInfo.length }} {{ 'cluster.config_items' | translate }})</span>
      </div>
      <button nbButton ghost size="tiny" status="basic" (click)="dialogRef.close()">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </nb-card-header>
    <nb-card-body>
      <div class="config-search mb-3">
        <input nbInput fullWidth [placeholder]="'cluster.search_config' | translate" [(ngModel)]="configSearchText" (input)="filterConfig()" />
      </div>
      <div *ngIf="configLoading" class="text-center py-4">
        <nb-spinner size="medium" status="primary"></nb-spinner>
        <div class="caption text-hint mt-2">{{ 'cluster.loading_config' | translate }}</div>
      </div>
      <div *ngIf="!configLoading" class="config-table-wrapper">
        <table class="config-table">
          <thead>
            <tr>
              <th class="col-key">{{ 'cluster.config_item' | translate }}</th>
              <th class="col-value">{{ 'common.value' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredConfigureInfo">
              <td class="col-key">{{ item.name }}</td>
              <td class="col-value">{{ item.value || '-' }}</td>
            </tr>
            <tr *ngIf="filteredConfigureInfo.length === 0">
              <td colspan="2" class="text-center text-hint py-3">{{ 'cluster.no_matching_config' | translate }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<div *ngIf="loading" class="text-center py-5">
  <nb-spinner status="primary" size="large"></nb-spinner>
</div>
