<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-header class="border-0">
        <div class="d-flex justify-content-between align-items-center">
          <h5>{{ 'cluster.overview_title' | translate }}</h5>
          <button nbButton ghost status="primary" (click)="addCluster()" [disabled]="!canCreateCluster">
            <nb-icon icon="plus-outline"></nb-icon>
            {{ 'cluster.add_cluster' | translate }}
          </button>
        </div>
      </nb-card-header>
      <nb-card-body>
        <div *ngIf="loading" class="text-center py-5">
          <nb-spinner status="primary" size="large"></nb-spinner>
        </div>

        <div *ngIf="!loading && !hasClusterAccess" class="text-center py-5">
          <div class="empty-state">
            <div class="icon-container status-warning">
              <nb-icon icon="shield-off-outline"></nb-icon>
            </div>
            <h6>{{ 'cluster.no_permission' | translate }}</h6>
            <p class="text-hint">{{ 'cluster.no_permission_hint' | translate }}</p>
          </div>
        </div>

        <div *ngIf="!loading && hasClusterAccess && clusters.length === 0" class="text-center py-5">
          <div class="empty-state">
            <div class="icon-container status-basic">
              <nb-icon icon="layers-outline"></nb-icon>
            </div>
            <h6>{{ 'cluster.no_clusters' | translate }}</h6>
            <p class="text-hint">{{ 'cluster.no_clusters_hint' | translate }}</p>
          </div>
        </div>

        <div *ngIf="!loading && hasClusterAccess && clusters.length > 0" class="row">
          <div *ngFor="let clusterCard of clusters" class="col-xxxl-3 col-xxl-4 col-md-6 mb-4">
            <nb-card class="cluster-card h-100" 
                    [class.active-card]="clusterCard.isActive"
                    [accent]="getStatusColor(clusterCard.health?.status)">
              <nb-card-header>
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center gap-2">
                    <nb-icon icon="cube" [status]="getStatusColor(clusterCard.health?.status)" class="cluster-icon"></nb-icon>
                    <div>
                      <div class="cluster-title-wrapper d-flex align-items-center gap-2" (click)="navigateToCluster(clusterCard.cluster.id)">
                        <h6 class="cluster-title text-basic mb-0">{{ clusterCard?.cluster?.name }}</h6>
                        <nb-icon icon="external-link-outline" class="action-icon"></nb-icon>
                      </div>
                      <div class="text-hint caption-2 mt-1" *ngIf="clusterCard.organization && isSuperAdmin">
                        {{ clusterCard.organization.name }}
                      </div>
                    </div>
                  </div>
                  
                  <div class="actions">
                    <button nbButton ghost size="small" status="basic" (click)="editCluster(clusterCard.cluster)" [disabled]="!canUpdateCluster" [nbTooltip]="'common.settings' | translate">
                      <nb-icon icon="settings-2-outline"></nb-icon>
                    </button>
                    <button nbButton ghost size="small" [status]="clusterCard.isActive ? 'warning' : 'basic'" (click)="toggleActiveCluster(clusterCard)" [disabled]="!canActivateCluster" [nbTooltip]="clusterCard.isActive ? ('common.activated' | translate) : ('common.set_as_current' | translate)">
                      <nb-icon [icon]="clusterCard.isActive ? 'star' : 'star-outline'"></nb-icon>
                    </button>
                    <button nbButton ghost size="small" status="danger" (click)="deleteCluster(clusterCard.cluster)" [disabled]="!canDeleteCluster" [nbTooltip]="'common.delete' | translate">
                      <nb-icon icon="trash-2-outline"></nb-icon>
                    </button>
                  </div>
                </div>
              </nb-card-header>

              <nb-card-body>
                <div class="metrics-row d-flex justify-content-between align-items-center mb-4">
                  <div class="metric-item text-center" [class.text-danger]="getHealthScore(clusterCard) !== '100'">
                     <div class="h4 mb-0 font-weight-bold">{{ getHealthScore(clusterCard) }}%</div>
                     <div class="caption-2 text-hint text-uppercase">{{ 'cluster.health_score' | translate }}</div>
                  </div>
                  <div class="divider-vertical"></div>
                  <div class="metric-item text-center cursor-pointer" (click)="navigateToFrontends(clusterCard.cluster.id)">
                     <div class="h4 mb-0 font-weight-bold text-primary">{{ getFeCount(clusterCard) }}</div>
                     <div class="caption-2 text-hint text-uppercase">{{ 'cluster.fe_nodes' | translate }}</div>
                  </div>
                  <div class="divider-vertical"></div>
                  <div class="metric-item text-center cursor-pointer" (click)="navigateToBackends(clusterCard.cluster.id)">
                     <div class="h4 mb-0 font-weight-bold text-info">{{ getComputeNodeCount(clusterCard) }}</div>
                     <div class="caption-2 text-hint text-uppercase">{{ getComputeNodeLabel(clusterCard) }}</div>
                  </div>
                </div>

                <div class="info-section">
                  <div class="info-row">
                    <nb-icon icon="link-2-outline" class="text-hint"></nb-icon>
                    <span class="text-basic subtitle-2">{{ clusterCard.cluster.fe_host }}:{{ clusterCard.cluster.fe_http_port }}</span>
                  </div>
                  
                  <div class="info-row" *ngIf="clusterCard.cluster.description">
                    <nb-icon icon="text-outline" class="text-hint"></nb-icon>
                    <span class="text-hint caption">{{ clusterCard.cluster.description }}</span>
                  </div>

                  <div class="tags-container" *ngIf="clusterCard.cluster.tags && clusterCard.cluster.tags.length > 0">
                    <nb-tag-list>
                      <nb-tag *ngFor="let tag of clusterCard.cluster.tags" [text]="tag" size="tiny" appearance="outline" status="basic"></nb-tag>
                    </nb-tag-list>
                  </div>
                </div>

                <div class="health-details-section" *ngIf="clusterCard.health">
                  <div class="d-flex justify-content-between align-items-center py-2 cursor-pointer" (click)="toggleHealthDetails(clusterCard)">
                    <div class="d-flex align-items-center">
                      <nb-icon [icon]="clusterCard.showHealthDetails ? 'chevron-down-outline' : 'chevron-right-outline'" pack="eva" class="text-hint me-1"></nb-icon>
                      <span class="caption-2 text-hint">{{ 'cluster.health_check_details' | translate }}</span>
                    </div>
                    <nb-tag *ngIf="getFailedChecksCount(clusterCard) > 0" [text]="getFailedChecksCount(clusterCard) + ' ' + ('common.abnormal' | translate)" status="danger" size="tiny"></nb-tag>
                    <nb-tag *ngIf="getFailedChecksCount(clusterCard) === 0" [text]="'common.normal' | translate" status="success" size="tiny"></nb-tag>
                  </div>

                  <div class="health-list mt-2" *ngIf="clusterCard.showHealthDetails">
                    <div *ngFor="let check of clusterCard.health.checks" class="health-item d-flex align-items-start py-2 border-bottom border-light">
                      <nb-icon [icon]="check.status === 'ok' ? 'checkmark-circle-2' : 'alert-circle'" [status]="check.status === 'ok' ? 'success' : 'danger'" class="me-2 mt-1"></nb-icon>
                      <div class="flex-grow-1">
                        <div class="subtitle-2">{{ check.name }}</div>
                        <div class="caption text-hint">{{ check.message }}</div>
                      </div>
                    </div>
                  </div>
                </div>

              </nb-card-body>
            </nb-card>
          </div>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>
