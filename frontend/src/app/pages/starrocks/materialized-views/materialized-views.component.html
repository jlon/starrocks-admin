<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">{{ 'materialized_views.title' | translate }}</h5>
            <span class="text-hint">|</span>
            <span class="text-hint" style="font-size: 13px;">
              {{ 'common.cluster_label' | translate }} <strong>{{ activeCluster?.name || ('common.not_selected' | translate) }}</strong>
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button
              nbButton
              status="primary"
              size="small"
              (click)="loadMaterializedViews()"
              [disabled]="loading || !clusterId"
            >
              <nb-icon icon="refresh-outline"></nb-icon>
              {{ 'common.refresh' | translate }}
            </button>
            <button
              nbButton
              status="success"
              size="small"
              (click)="openCreateDialog()"
              [disabled]="!clusterId"
            >
              <nb-icon icon="plus-outline"></nb-icon>
              {{ 'common.create' | translate }}
            </button>
          </div>
        </div>
      </nb-card-header>

      <nb-card-body>
        <!-- Basic Filters -->
        <div class="filter-section">
          <div class="row">
            <div class="col-md-3 col-sm-6 mb-2">
              <input
                nbInput
                fullWidth
                type="text"
                [placeholder]="'materialized_views.search_placeholder' | translate"
                [(ngModel)]="searchText"
                (ngModelChange)="onSearch()"
              />
            </div>
            <div class="col-md-2 col-sm-6 mb-2">
              <nb-select
                fullWidth
                [placeholder]="'materialized_views.select_database' | translate"
                [(selected)]="selectedDatabase"
                (selectedChange)="applyFilters()"
              >
                <nb-option value="all">{{ 'materialized_views.all_databases' | translate }}</nb-option>
                <nb-option *ngFor="let db of databases" [value]="db">
                  {{ db }}
                </nb-option>
              </nb-select>
            </div>
            <div class="col-md-2 col-sm-6 mb-2">
              <nb-select
                fullWidth
                [placeholder]="'materialized_views.refresh_type' | translate"
                [(selected)]="selectedRefreshType"
                (selectedChange)="applyFilters()"
              >
                <nb-option
                  *ngFor="let option of refreshTypeOptions"
                  [value]="option.value"
                >
                  {{ option.label }}
                </nb-option>
              </nb-select>
            </div>
            <div class="col-md-2 col-sm-6 mb-2">
              <nb-select
                fullWidth
                [placeholder]="'materialized_views.status' | translate"
                [(selected)]="selectedActiveState"
                (selectedChange)="applyFilters()"
              >
                <nb-option
                  *ngFor="let option of activeStateOptions"
                  [value]="option.value"
                >
                  {{ option.label }}
                </nb-option>
              </nb-select>
            </div>
            <div class="col-md-2 col-sm-6 mb-2">
              <nb-select
                fullWidth
                [placeholder]="'materialized_views.refresh_state' | translate"
                [(selected)]="selectedRefreshState"
                (selectedChange)="applyFilters()"
              >
                <nb-option
                  *ngFor="let option of refreshStateOptions"
                  [value]="option.value"
                >
                  {{ option.label }}
                </nb-option>
              </nb-select>
            </div>
            <div class="col-md-1 col-sm-12 mb-2">
              <button
                nbButton
                fullWidth
                status="info"
                size="small"
                (click)="toggleAdvancedFilters()"
              >
                <nb-icon
                  [icon]="showAdvancedFilters ? 'arrow-up-outline' : 'arrow-down-outline'"
                ></nb-icon>
                {{ 'materialized_views.advanced_filters' | translate }}
              </button>
            </div>
          </div>

          <!-- Advanced Filters -->
          <div *ngIf="showAdvancedFilters" class="advanced-filters mt-3">
            <nb-card accent="info">
              <nb-card-header>{{ 'materialized_views.advanced_filters' | translate }}</nb-card-header>
              <nb-card-body>
                <div class="row">
                  <div class="col-md-3 col-sm-6 mb-2">
                    <label class="label">{{ 'materialized_views.refresh_time_start' | translate }}</label>
                    <input
                      nbInput
                      fullWidth
                      type="datetime-local"
                      [(ngModel)]="refreshTimeStart"
                      (ngModelChange)="applyFilters()"
                    />
                  </div>
                  <div class="col-md-3 col-sm-6 mb-2">
                    <label class="label">{{ 'materialized_views.refresh_time_end' | translate }}</label>
                    <input
                      nbInput
                      fullWidth
                      type="datetime-local"
                      [(ngModel)]="refreshTimeEnd"
                      (ngModelChange)="applyFilters()"
                    />
                  </div>
                  <div class="col-md-2 col-sm-6 mb-2">
                    <label class="label">{{ 'materialized_views.min_rows' | translate }}</label>
                    <input
                      nbInput
                      fullWidth
                      type="number"
                      [placeholder]="'materialized_views.min_rows' | translate"
                      [(ngModel)]="rowCountMin"
                      (ngModelChange)="applyFilters()"
                    />
                  </div>
                  <div class="col-md-2 col-sm-6 mb-2">
                    <label class="label">{{ 'materialized_views.max_rows' | translate }}</label>
                    <input
                      nbInput
                      fullWidth
                      type="number"
                      [placeholder]="'materialized_views.max_rows' | translate"
                      [(ngModel)]="rowCountMax"
                      (ngModelChange)="applyFilters()"
                    />
                  </div>
                  <div class="col-md-2 col-sm-6 mb-2">
                    <label class="label">{{ 'materialized_views.partition_type' | translate }}</label>
                    <nb-select
                      fullWidth
                      [(selected)]="selectedPartitionType"
                      (selectedChange)="applyFilters()"
                    >
                      <nb-option
                        *ngFor="let option of partitionTypeOptions"
                        [value]="option.value"
                      >
                        {{ option.label }}
                      </nb-option>
                    </nb-select>
                  </div>
                </div>
              </nb-card-body>
            </nb-card>
          </div>

          <!-- Active Filters Display -->
          <div *ngIf="getActiveFiltersCount() > 0" class="active-filters mt-2">
            <span class="me-2">{{ 'materialized_views.current_filters' | translate }}</span>
            <nb-badge
              *ngIf="searchText"
              status="info"
              text="{{ 'common.search' | translate }}: {{ searchText }}"
              class="me-2"
            ></nb-badge>
            <nb-badge
              *ngIf="selectedDatabase !== 'all'"
              status="info"
              text="{{ 'materialized_views.mv_database' | translate }}: {{ selectedDatabase }}"
              class="me-2"
            ></nb-badge>
            <nb-badge
              *ngIf="selectedRefreshType !== 'all'"
              status="info"
              text="{{ 'common.type' | translate }}: {{ selectedRefreshType }}"
              class="me-2"
            ></nb-badge>
            <nb-badge
              *ngIf="selectedActiveState !== 'all'"
              status="info"
              text="{{ 'common.status' | translate }}: {{ selectedActiveState }}"
              class="me-2"
            ></nb-badge>
            <nb-badge
              *ngIf="selectedRefreshState !== 'all'"
              status="info"
              text="{{ 'materialized_views.refresh_state' | translate }}: {{ selectedRefreshState }}"
              class="me-2"
            ></nb-badge>
            <button
              nbButton
              size="tiny"
              status="danger"
              (click)="clearAllFilters()"
            >
              <nb-icon icon="close-outline"></nb-icon>
              {{ 'materialized_views.clear_all' | translate }}
            </button>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div *ngIf="loading" class="text-center mt-3">
          <nb-spinner status="primary"></nb-spinner>
        </div>

        <!-- Data Table -->
        <ng2-smart-table
          *ngIf="!loading"
          [settings]="settings"
          [source]="source"
          (edit)="onEdit($event)"
          (delete)="onDelete($event)"
        >
        </ng2-smart-table>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- Create Dialog -->
<ng-template #createDialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ 'materialized_views.create_mv' | translate }}</h5>
        <button nbButton ghost (click)="closeCreateDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <nb-accordion>
        <nb-accordion-item>
          <nb-accordion-item-header>{{ 'materialized_views.sql_template' | translate }}</nb-accordion-item-header>
          <nb-accordion-item-body>
            <div class="template-section">
              <h6>{{ 'materialized_views.async_manual' | translate }}</h6>
              <pre class="code-template">CREATE MATERIALIZED VIEW mv_async_manual
DISTRIBUTED BY HASH(order_date) BUCKETS 10
REFRESH MANUAL
AS SELECT
    order_date,
    SUM(amount) as daily_sales,
    COUNT(*) as order_count
FROM orders
GROUP BY order_date;</pre>

              <h6>{{ 'materialized_views.async_auto' | translate }}</h6>
              <pre class="code-template">CREATE MATERIALIZED VIEW mv_async_auto
DISTRIBUTED BY HASH(order_date) BUCKETS 10
REFRESH ASYNC EVERY (INTERVAL 1 HOUR)
AS SELECT
    order_date,
    SUM(amount) as daily_sales
FROM orders
GROUP BY order_date;</pre>

              <h6>{{ 'materialized_views.sync_rollup' | translate }}</h6>
              <pre class="code-template">CREATE MATERIALIZED VIEW mv_sync_rollup
AS SELECT
    customer_id,
    order_date,
    SUM(amount) as total_amount,
    COUNT(*) as order_count
FROM orders
GROUP BY customer_id, order_date;</pre>
            </div>
          </nb-accordion-item-body>
        </nb-accordion-item>
      </nb-accordion>

      <div class="form-group mt-3">
        <label class="label">{{ 'materialized_views.create_sql_label' | translate }}</label>
        <textarea
          nbInput
          fullWidth
          rows="12"
          [placeholder]="'materialized_views.create_sql_placeholder' | translate"
          [(ngModel)]="createSQL"
          [disabled]="creating"
        ></textarea>
        <small class="form-text text-muted">
          <nb-icon icon="bulb-outline"></nb-icon>
          {{ 'materialized_views.create_sql_hint' | translate }}
        </small>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end gap-2">
        <button
          nbButton
          status="basic"
          (click)="closeCreateDialog()"
          [disabled]="creating"
        >
          {{ 'common.cancel' | translate }}
        </button>
        <button
          nbButton
          status="primary"
          (click)="createMV()"
          [disabled]="creating || !createSQL.trim()"
        >
          <nb-icon icon="checkmark-outline"></nb-icon>
          {{ creating ? ('materialized_views.creating' | translate) : ('common.create' | translate) }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- Detail Dialog -->
<ng-template #detailDialog let-data let-ref="dialogRef">
  <nb-card *ngIf="selectedMV">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ 'materialized_views.detail_title' | translate }}: {{ selectedMV.name }}</h5>
        <button nbButton ghost (click)="closeDetailDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <nb-tabset>
        <nb-tab [tabTitle]="'materialized_views.basic_info' | translate">
          <div class="detail-section">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_name' | translate }}</label>
                <p>{{ selectedMV.name }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_database' | translate }}</label>
                <p>{{ selectedMV.database_name }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_refresh_type' | translate }}</label>
                <p [innerHTML]="getRefreshTypeBadge(selectedMV.refresh_type)"></p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_status' | translate }}</label>
                <p>
                  <span *ngIf="selectedMV.is_active" class="badge badge-success">{{ 'materialized_views.active' | translate }}</span>
                  <span *ngIf="!selectedMV.is_active" class="badge badge-warning">{{ 'materialized_views.inactive' | translate }}</span>
                </p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_partition_type' | translate }}</label>
                <p>{{ selectedMV.partition_type || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_rows' | translate }}</label>
                <p>{{ selectedMV.rows || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_task_id' | translate }}</label>
                <p>{{ selectedMV.task_id || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.mv_task_name' | translate }}</label>
                <p>{{ selectedMV.task_name || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.last_refresh_start' | translate }}</label>
                <p>{{ selectedMV.last_refresh_start_time || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.last_refresh_end' | translate }}</label>
                <p>{{ selectedMV.last_refresh_finished_time || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.last_refresh_duration' | translate }}</label>
                <p>{{ selectedMV.last_refresh_duration || '-' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <label class="label">{{ 'materialized_views.last_refresh_state' | translate }}</label>
                <p [innerHTML]="getRefreshStateBadge(selectedMV.last_refresh_state)"></p>
              </div>

              <!-- Error information -->
              <div class="col-12 mb-3" *ngIf="selectedMV.last_refresh_error_message">
                <label class="label">{{ 'materialized_views.refresh_error_info' | translate }}</label>
                <nb-alert status="danger" closable="false">
                  <strong>{{ 'materialized_views.error_code' | translate }}</strong>{{ selectedMV.last_refresh_error_code || '-' }}<br>
                  <strong>{{ 'materialized_views.error_message' | translate }}</strong>{{ selectedMV.last_refresh_error_message }}
                </nb-alert>
              </div>

              <!-- Partition information -->
              <div class="col-md-6 mb-3" *ngIf="selectedMV.last_refresh_start_partition">
                <label class="label">{{ 'materialized_views.last_refresh_start_partition' | translate }}</label>
                <p>{{ selectedMV.last_refresh_start_partition }}</p>
              </div>
              <div class="col-md-6 mb-3" *ngIf="selectedMV.last_refresh_end_partition">
                <label class="label">{{ 'materialized_views.last_refresh_end_partition' | translate }}</label>
                <p>{{ selectedMV.last_refresh_end_partition }}</p>
              </div>

              <!-- Force refresh flag -->
              <div class="col-md-6 mb-3" *ngIf="selectedMV.last_refresh_force_refresh !== undefined && selectedMV.last_refresh_force_refresh !== null">
                <label class="label">{{ 'materialized_views.force_refresh' | translate }}</label>
                <p>
                  <span *ngIf="selectedMV.last_refresh_force_refresh" class="badge badge-warning">{{ 'users.yes' | translate }}</span>
                  <span *ngIf="!selectedMV.last_refresh_force_refresh" class="badge badge-basic">{{ 'users.no' | translate }}</span>
                </p>
              </div>
            </div>
          </div>
        </nb-tab>
        <nb-tab [tabTitle]="'materialized_views.ddl_statement' | translate">
          <div class="ddl-section">
            <textarea
              nbInput
              fullWidth
              [value]="mvDDL"
              readonly
            ></textarea>
          </div>
        </nb-tab>
      </nb-tabset>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-between">
        <div class="d-flex gap-2">
          <button nbButton status="info" size="small" (click)="closeDetailDialog(); openEditDialog(selectedMV)">
            <nb-icon icon="edit-outline"></nb-icon>
            {{ 'common.edit' | translate }}
          </button>
          <button
            *ngIf="selectedMV.refresh_type !== 'ROLLUP'"
            nbButton
            status="success"
            size="small"
            (click)="closeDetailDialog(); openRefreshDialog(selectedMV)"
          >
            <nb-icon icon="refresh-outline"></nb-icon>
            {{ 'common.refresh' | translate }}
          </button>
          <button
            *ngIf="selectedMV.refresh_type !== 'ROLLUP'"
            nbButton
            [status]="selectedMV.is_active ? 'warning' : 'success'"
            size="small"
            (click)="closeDetailDialog(); toggleActiveState(selectedMV)"
          >
            <nb-icon icon="power-outline"></nb-icon>
            {{ selectedMV.is_active ? ('materialized_views.deactivate' | translate) : ('materialized_views.activate' | translate) }}
          </button>
        </div>
        <button nbButton status="basic" (click)="closeDetailDialog()">
          {{ 'common.close' | translate }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- Refresh Dialog -->
<ng-template #refreshDialog let-data let-ref="dialogRef">
  <nb-card *ngIf="selectedMV">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ 'materialized_views.refresh_mv' | translate }}: {{ selectedMV.name }}</h5>
        <button nbButton ghost (click)="closeRefreshDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="form-group">
        <label class="label">{{ 'materialized_views.refresh_mode' | translate }}</label>
        <nb-select fullWidth [(selected)]="refreshMode">
          <nb-option *ngFor="let option of refreshModeOptions" [value]="option.value">
            {{ option.label }}
          </nb-option>
        </nb-select>
        <small class="form-text text-muted">
          {{ 'materialized_views.refresh_mode_hint' | translate }}
        </small>
      </div>

      <div class="form-group mt-3">
        <nb-checkbox [(checked)]="refreshForce">
          {{ 'materialized_views.force_refresh_option' | translate }}
        </nb-checkbox>
        <small class="form-text text-muted d-block">
          {{ 'materialized_views.force_refresh_hint' | translate }}
        </small>
      </div>

      <div class="form-group mt-3" *ngIf="selectedMV.partition_type && selectedMV.partition_type !== 'UNPARTITIONED'">
        <label class="label">{{ 'materialized_views.partition_refresh' | translate }}</label>
        <div class="row">
          <div class="col-md-6">
            <input
              nbInput
              fullWidth
              type="text"
              [placeholder]="'materialized_views.start_partition' | translate"
              [(ngModel)]="refreshPartitionStart"
            />
          </div>
          <div class="col-md-6">
            <input
              nbInput
              fullWidth
              type="text"
              [placeholder]="'materialized_views.end_partition' | translate"
              [(ngModel)]="refreshPartitionEnd"
            />
          </div>
        </div>
        <small class="form-text text-muted">
          <nb-icon icon="info-outline"></nb-icon>
          {{ 'materialized_views.partition_refresh_hint' | translate }}
        </small>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end gap-2">
        <button
          nbButton
          status="basic"
          (click)="closeRefreshDialog()"
          [disabled]="refreshing"
        >
          {{ 'common.cancel' | translate }}
        </button>
        <button
          nbButton
          status="primary"
          (click)="refreshMV()"
          [disabled]="refreshing"
        >
          <nb-icon icon="refresh-outline"></nb-icon>
          {{ refreshing ? ('materialized_views.refreshing' | translate) : ('materialized_views.start_refresh' | translate) }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- Edit Dialog -->
<ng-template #editDialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ 'materialized_views.edit_mv' | translate }}: {{ selectedMV?.name }}</h5>
        <button nbButton ghost (click)="closeEditDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="form-group">
        <label class="label">{{ 'materialized_views.operation_type' | translate }}</label>
        <nb-select [(selected)]="editAction" fullWidth>
          <nb-option value="rename">{{ 'materialized_views.rename' | translate }}</nb-option>
          <nb-option value="refresh_strategy">{{ 'materialized_views.modify_refresh_strategy' | translate }}</nb-option>
          <nb-option value="properties">{{ 'materialized_views.modify_properties' | translate }}</nb-option>
          <nb-option value="advanced">{{ 'materialized_views.advanced_mode' | translate }}</nb-option>
        </nb-select>
      </div>

      <!-- Rename Form -->
      <div *ngIf="editAction === 'rename'" class="form-group">
        <label class="label">{{ 'materialized_views.new_name' | translate }} <span class="text-danger">*</span></label>
        <input
          nbInput
          fullWidth
          type="text"
          [(ngModel)]="editNewName"
          [placeholder]="'materialized_views.new_name_placeholder' | translate"
        />
        <p class="caption text-hint mt-2">
          <nb-icon icon="info-outline"></nb-icon>
          将生成SQL: ALTER MATERIALIZED VIEW {{ selectedMV?.database_name }}.{{ selectedMV?.name }} RENAME {{ editNewName }}
        </p>
      </div>

      <!-- Refresh Strategy Form -->
      <div *ngIf="editAction === 'refresh_strategy'">
        <div class="form-group">
          <label class="label">{{ 'materialized_views.refresh_strategy' | translate }} <span class="text-danger">*</span></label>
          <nb-select [(selected)]="editRefreshStrategy" fullWidth>
            <nb-option value="MANUAL">{{ 'materialized_views.manual_refresh' | translate }}</nb-option>
            <nb-option value="ASYNC">{{ 'materialized_views.auto_refresh' | translate }}</nb-option>
          </nb-select>
        </div>

        <div *ngIf="editRefreshStrategy === 'ASYNC'" class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="label">{{ 'materialized_views.refresh_interval' | translate }}</label>
              <input
                nbInput
                fullWidth
                type="number"
                min="1"
                [(ngModel)]="editRefreshInterval"
                placeholder="1"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="label">{{ 'materialized_views.time_unit' | translate }}</label>
              <nb-select [(selected)]="editRefreshUnit" fullWidth>
                <nb-option value="HOUR">{{ 'materialized_views.hour' | translate }}</nb-option>
                <nb-option value="DAY">{{ 'materialized_views.day' | translate }}</nb-option>
                <nb-option value="WEEK">{{ 'materialized_views.week' | translate }}</nb-option>
                <nb-option value="MONTH">{{ 'materialized_views.month' | translate }}</nb-option>
              </nb-select>
            </div>
          </div>
        </div>

        <p class="caption text-hint mt-2">
          <nb-icon icon="info-outline"></nb-icon>
          <span *ngIf="editRefreshStrategy === 'MANUAL'">
            将生成SQL: ALTER MATERIALIZED VIEW ... REFRESH MANUAL
          </span>
          <span *ngIf="editRefreshStrategy === 'ASYNC'">
            将生成SQL: ALTER MATERIALIZED VIEW ... REFRESH ASYNC EVERY(INTERVAL {{ editRefreshInterval }} {{ editRefreshUnit }})
          </span>
        </p>
      </div>

      <!-- Properties Form -->
      <div *ngIf="editAction === 'properties'">
        <div class="form-group">
          <label class="label">{{ 'materialized_views.property_name' | translate }} <span class="text-danger">*</span></label>
          <input
            nbInput
            fullWidth
            type="text"
            [(ngModel)]="editPropertyKey"
            [placeholder]="'materialized_views.property_name_placeholder' | translate"
          />
        </div>
        <div class="form-group">
          <label class="label">{{ 'materialized_views.property_value' | translate }} <span class="text-danger">*</span></label>
          <input
            nbInput
            fullWidth
            type="text"
            [(ngModel)]="editPropertyValue"
            [placeholder]="'materialized_views.property_value_placeholder' | translate"
          />
        </div>

        <nb-accordion class="mt-3">
          <nb-accordion-item>
            <nb-accordion-item-header>{{ 'materialized_views.common_properties' | translate }}</nb-accordion-item-header>
            <nb-accordion-item-body>
              <ul class="list-unstyled small">
                <li><strong>session.enable_profile</strong> - 启用Profile (true/false)</li>
                <li><strong>session.enable_spill</strong> - 启用中间结果落盘 (true/false)</li>
                <li><strong>session.spill_mode</strong> - 落盘模式 (auto/force)</li>
                <li><strong>mv_rewrite_staleness_second</strong> - 查询改写Staleness时间（秒）</li>
                <li><strong>partition_ttl_number</strong> - 分区TTL数量</li>
                <li><strong>partition_refresh_number</strong> - 分区刷新数量</li>
              </ul>
            </nb-accordion-item-body>
          </nb-accordion-item>
        </nb-accordion>

        <p class="caption text-hint mt-2">
          <nb-icon icon="info-outline"></nb-icon>
          将生成SQL: ALTER MATERIALIZED VIEW ... SET ("{{ editPropertyKey }}" = "{{ editPropertyValue }}")
        </p>
      </div>

      <!-- Advanced Form -->
      <div *ngIf="editAction === 'advanced'">
        <div class="form-group">
          <label class="label">{{ 'materialized_views.alter_clause' | translate }} <span class="text-danger">*</span></label>
          <textarea
            nbInput
            fullWidth
            rows="4"
            [(ngModel)]="editAdvancedClause"
            [placeholder]="'materialized_views.alter_clause_placeholder' | translate"
          ></textarea>
        </div>

        <nb-alert status="info" closable="false">
          <strong>{{ 'materialized_views.supported_alter_clauses' | translate }}</strong>
          <ul class="mb-0 mt-2">
            <li><code>RENAME new_name</code> - 重命名</li>
            <li><code>REFRESH MANUAL</code> 或 <code>REFRESH ASYNC EVERY(...)</code> - 修改刷新策略</li>
            <li><code>ACTIVE</code> 或 <code>INACTIVE</code> - 修改状态</li>
            <li><code>SET ("key" = "value")</code> - 修改属性</li>
            <li><code>SWAP WITH other_mv_name</code> - 原子替换</li>
          </ul>
        </nb-alert>

        <p class="caption text-hint mt-2">
          <nb-icon icon="alert-triangle-outline"></nb-icon>
          请确保ALTER子句语法正确，完整SQL将为: ALTER MATERIALIZED VIEW {{ selectedMV?.database_name }}.{{ selectedMV?.name }} {{ editAdvancedClause }}
        </p>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end gap-2">
        <button
          nbButton
          status="basic"
          (click)="closeEditDialog()"
          [disabled]="editing"
        >
          {{ 'common.cancel' | translate }}
        </button>
        <button
          nbButton
          status="primary"
          (click)="editMV()"
          [disabled]="editing"
        >
          <nb-icon icon="checkmark-outline"></nb-icon>
          {{ editing ? ('materialized_views.modifying' | translate) : ('materialized_views.confirm_modify' | translate) }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>
