<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">{{ 'queries.audit_logs' | translate }}</h5>
            <span class="text-hint">|</span>
            <span class="text-hint" style="font-size: 13px;">
              {{ 'common.cluster_label' | translate }} <strong>{{ activeCluster?.name || ('common.not_selected' | translate) }}</strong>
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button nbButton status="primary" size="small" (click)="loadHistoryQueries()" [disabled]="loading || !clusterId">
              <nb-icon icon="refresh-outline"></nb-icon>
              {{ 'common.refresh' | translate }}
            </button>
            
            <nb-select 
              [(selected)]="selectedRefreshInterval" 
              size="small" 
              [placeholder]="'overview.auto_refresh' | translate"
              (selectedChange)="onRefreshIntervalChange($event)"
              [disabled]="!clusterId"
              style="min-width: 100px;"
            >
              <nb-option *ngFor="let option of refreshIntervalOptions" [value]="option.value">
                {{ option.label }}
              </nb-option>
            </nb-select>
          </div>
        </div>
      </nb-card-header>
      <nb-card-body>
        <!-- Search Filters -->
        <div class="search-filters">
          <nb-card status="basic" class="filter-card">
            <nb-card-body>
              <div class="row align-items-center">
                <div class="col-md-4">
                  <nb-form-field>
                    <input 
                      nbInput 
                      fullWidth 
                      [placeholder]="'queries.search_placeholder' | translate"
                      [(ngModel)]="searchKeyword"
                      (keyup.enter)="searchHistory()">
                  </nb-form-field>
                </div>
                <div class="col-md-3">
                  <nb-form-field>
                    <nb-icon nbPrefix icon="calendar-outline"></nb-icon>
                    <input 
                      nbInput 
                      fullWidth 
                      [placeholder]="'queries.start_time' | translate"
                      type="datetime-local"
                      [(ngModel)]="searchStartTime">
                  </nb-form-field>
                </div>
                <div class="col-md-3">
                  <nb-form-field>
                    <nb-icon nbPrefix icon="calendar-outline"></nb-icon>
                    <input 
                      nbInput 
                      fullWidth 
                      [placeholder]="'queries.end_time' | translate"
                      type="datetime-local"
                      [(ngModel)]="searchEndTime">
                  </nb-form-field>
                </div>
                <div class="col-md-2">
                  <button 
                    nbButton 
                    status="primary" 
                    fullWidth
                    size="small"
                    (click)="searchHistory()">
                    {{ 'common.search' | translate }}
                  </button>
                </div>
              </div>
              <div class="row mt-2" *ngIf="hasActiveFilters()">
                <div class="col-12">
                  <div class="active-filters">
                    <span class="filter-label">{{ 'queries.current_filters' | translate }}</span>
                    <nb-badge 
                      *ngIf="searchKeyword" 
                      status="info" 
                      [text]="('queries.keyword' | translate) + ': ' + searchKeyword"
                      class="filter-badge">
                    </nb-badge>
                    <nb-badge 
                      *ngIf="searchStartTime" 
                      status="warning" 
                      [text]="('queries.start_time' | translate) + ': ' + searchStartTime"
                      class="filter-badge">
                    </nb-badge>
                    <nb-badge 
                      *ngIf="searchEndTime" 
                      status="warning" 
                      [text]="('queries.end_time' | translate) + ': ' + searchEndTime"
                      class="filter-badge">
                    </nb-badge>
                    <button 
                      nbButton 
                      ghost 
                      status="basic" 
                      size="tiny"
                      (click)="clearFilters()"
                      class="clear-filters-btn">
                      <nb-icon icon="close-outline"></nb-icon>
                      {{ 'queries.clear_filters' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary"></nb-spinner></div>
        
        <ng2-smart-table 
          *ngIf="!loading" 
          [settings]="historySettings" 
          [source]="historySource"
          (edit)="onEditProfile($event)">
        </ng2-smart-table>

        <!-- Custom pagination -->
        <div *ngIf="!loading && historyTotalCount > 0" class="pagination-container">
          <div class="pagination-info">
            <span>{{ 'queries.showing_records' | translate: {start: (historyCurrentPage - 1) * historyPageSize + 1, end: Math.min(historyCurrentPage * historyPageSize, historyTotalCount), total: historyTotalCount} }}</span>
            <nb-select 
              [(selected)]="historyPageSize" 
              size="tiny"
              (selectedChange)="onHistoryPageSizeChange($event)"
              class="page-size-select">
              <nb-option [value]="5">5 {{ 'queries.records_per_page' | translate }}</nb-option>
              <nb-option [value]="10">10 {{ 'queries.records_per_page' | translate }}</nb-option>
              <nb-option [value]="20">20 {{ 'queries.records_per_page' | translate }}</nb-option>
              <nb-option [value]="50">50 {{ 'queries.records_per_page' | translate }}</nb-option>
              <nb-option [value]="100">100 {{ 'queries.records_per_page' | translate }}</nb-option>
            </nb-select>
          </div>
          <div class="pagination-controls">
            <button 
              nbButton 
              size="tiny" 
              status="basic"
              [disabled]="historyCurrentPage === 1"
              (click)="onHistoryPageChange(1)">
              <nb-icon icon="chevron-left-outline"></nb-icon><nb-icon icon="chevron-left-outline"></nb-icon>
            </button>
            <button 
              nbButton 
              size="tiny" 
              status="basic"
              [disabled]="historyCurrentPage === 1"
              (click)="onHistoryPageChange(historyCurrentPage - 1)">
              <nb-icon icon="chevron-left-outline"></nb-icon>
            </button>
            <span class="page-info">{{ 'queries.page_info' | translate: {current: historyCurrentPage, total: historyTotalPages} }}</span>
            <button 
              nbButton 
              size="tiny" 
              status="basic"
              [disabled]="historyCurrentPage === historyTotalPages"
              (click)="onHistoryPageChange(historyCurrentPage + 1)">
              <nb-icon icon="chevron-right-outline"></nb-icon>
            </button>
            <button 
              nbButton 
              size="tiny" 
              status="basic"
              [disabled]="historyCurrentPage === historyTotalPages"
              (click)="onHistoryPageChange(historyTotalPages)">
              <nb-icon icon="chevron-right-outline"></nb-icon><nb-icon icon="chevron-right-outline"></nb-icon>
            </button>
          </div>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- Profile Dialog Template -->
<ng-template #profileDialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h6>Query Profile</h6>
        <button nbButton ghost status="basic" size="tiny" (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body *ngIf="currentProfile">
      <div class="profile-info">
        <p><strong>Query ID:</strong> {{ currentProfile.query_id }}</p>
        <p><strong>SQL:</strong></p>
        <pre class="sql-statement">{{ currentProfile.sql }}</pre>
        <p><strong>{{ 'queries.execution_time' | translate }}:</strong> {{ currentProfile.execution_time_ms }} ms</p>
        <p><strong>{{ 'queries.status' | translate }}:</strong> {{ currentProfile.status }}</p>
        <hr>
        <p><strong>{{ 'queries.profile_content' | translate }}:</strong></p>
        <pre class="profile-content">{{ currentProfile.profile_content }}</pre>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>
