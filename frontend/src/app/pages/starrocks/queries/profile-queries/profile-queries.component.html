<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">Profiles</h5>
            <span class="text-hint">|</span>
            <span class="text-hint" style="font-size: 13px;">
              ÈõÜÁæ§: <strong>{{ activeCluster?.name || 'Êú™ÈÄâÊã©' }}</strong>
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button nbButton status="primary" size="small" (click)="loadProfiles()" [disabled]="loading || !clusterId">
              <nb-icon icon="refresh-outline"></nb-icon>
              Âà∑Êñ∞
            </button>
            
            <nb-select 
              [(selected)]="selectedRefreshInterval" 
              size="small" 
              placeholder="Ëá™Âä®Âà∑Êñ∞"
              (selectedChange)="onRefreshIntervalChange($event)"
              [disabled]="!clusterId"
              style="min-width: 100px;"
            >
              <nb-option *ngFor="let option of refreshIntervalOptions" [value]="option.value">
                {{ option.label }}
              </nb-option>
            </nb-select>
          </div>
        </div>
      </nb-card-header>
      <nb-card-body>
        <div class="profile-container">
          <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary"></nb-spinner></div>
          <ng2-smart-table 
            *ngIf="!loading" 
            [settings]="profileSettings" 
            [source]="profileSource"
            (edit)="onProfileEdit($event)">
          </ng2-smart-table>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- Profile Detail Dialog Template -->
<ng-template #profileDetailDialog let-data let-ref="dialogRef">
  <nb-card class="profile-dialog-card" 
           [ngStyle]="{'width': '90vw', 'max-width': '1400px', 'height': '85vh', 'overflow': 'hidden'}">
    <nb-card-header class="profile-dialog-header">
      <div class="header-left">
        <h5>Query Profile ËØ¶ÊÉÖ</h5>
        <p class="header-subtitle" *ngIf="currentQueryId">
          <nb-icon icon="hash-outline" class="subtitle-icon"></nb-icon>
          {{ currentQueryId }}
        </p>
      </div>
      <div class="header-actions">
        <button nbButton outline status="primary" size="small" (click)="refreshAnalysis()" [disabled]="profileDetailLoading">
          <nb-icon icon="refresh-outline"></nb-icon>
          Âà∑Êñ∞
        </button>
        <button nbButton ghost status="basic" (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body class="p-0">
      <nb-tabset>
        <!-- Tab 1: DAG ÊâßË°åÂàÜÊûê (ÈªòËÆ§) -->
        <nb-tab tabTitle="ÊâßË°åÂàÜÊûê" tabIcon="activity-outline">
          <div class="dag-container">
            <div *ngIf="analysisLoading" class="text-center py-5">
              <nb-spinner status="primary" size="large"></nb-spinner>
              <p class="mt-3 text-hint">Ê≠£Âú®ÂàÜÊûê Profile...</p>
            </div>
            
            <div *ngIf="!analysisLoading && analysisError" class="text-center py-5">
              <nb-icon icon="alert-triangle-outline" status="warning" class="mb-2" style="font-size: 2rem;"></nb-icon>
              <p class="text-hint">{{ analysisError }}</p>
              <p class="text-hint" style="font-size: 12px;">
                ÊèêÁ§∫: StarRocks ÁöÑ Profile Êï∞ÊçÆ‰ºöÂÆöÊúüÊ∏ÖÁêÜÔºåËæÉÊó©ÁöÑÊü•ËØ¢ÂèØËÉΩÂ∑≤Êó†Ê≥ïËé∑ÂèñËØ¶ÁªÜÂàÜÊûê„ÄÇ
              </p>
            </div>
            
            <div *ngIf="!analysisLoading && !analysisError && analysisData" class="dag-layout" [class.fullscreen-mode]="isFullscreen">

              <!-- Center Panel: Graph (No left panel, like Figure 1) -->
              <div class="dag-center-panel" 
                   (wheel)="onWheel($event)"
                   (mousedown)="startPan($event)"
                   (window:mousemove)="pan($event)"
                   (window:mouseup)="endPan()"
                   (click)="onDagPanelClick($event)">
                <!-- Toolbar -->
                <div class="dag-toolbar">
                  <button nbButton size="tiny" status="basic" ghost (click)="toggleFullscreen()" [nbTooltip]="isFullscreen ? 'ÈÄÄÂá∫ÂÖ®Â±è' : 'ÂÖ®Â±è'">
                    <nb-icon [icon]="isFullscreen ? 'collapse-outline' : 'expand-outline'"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="zoomIn()" nbTooltip="ÊîæÂ§ß">
                    <nb-icon icon="plus-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="zoomOut()" nbTooltip="Áº©Â∞è">
                    <nb-icon icon="minus-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="resetZoom()" nbTooltip="ÈáçÁΩÆ">
                    <nb-icon icon="maximize-outline"></nb-icon>
                  </button>
                </div>
                
                <div class="graph-viewport">
                  <div class="graph-content" 
                       [style.width.px]="graphWidth" 
                       [style.height.px]="graphHeight"
                       [style.transform]="'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + zoomLevel + ')'"
                       [style.transformOrigin]="'center center'">
                    
                    <!-- Edges - Lines with dynamic width based on rows -->
                    <svg class="edges-svg" [attr.width]="graphWidth" [attr.height]="graphHeight">
                      <!-- Arrow marker definitions -->
                      <defs>
                        <marker *ngFor="let edge of graphEdges"
                                [attr.id]="edge.markerId"
                                [attr.markerWidth]="edge.arrowSize"
                                [attr.markerHeight]="edge.arrowSize"
                                [attr.refX]="edge.arrowSize"
                                [attr.refY]="edge.arrowSize / 2"
                                orient="auto"
                                markerUnits="userSpaceOnUse">
                          <!-- Triangle pointing RIGHT (orient=auto rotates to path direction) -->
                          <polygon [attr.points]="'0,0 ' + edge.arrowSize + ',' + (edge.arrowSize/2) + ' 0,' + edge.arrowSize"
                                   [attr.fill]="edge.strokeColor"/>
                        </marker>
                      </defs>
                      <g *ngFor="let edge of graphEdges">
                        <path [attr.d]="getEdgePath(edge.points)" 
                              class="edge-path" 
                              [attr.stroke]="edge.strokeColor"
                              [attr.stroke-width]="edge.strokeWidth"
                              [attr.marker-end]="'url(#' + edge.markerId + ')'" />
                      </g>
                    </svg>
                    
                    <!-- Edge Labels -->
                    <div class="edge-labels-layer">
                      <ng-container *ngFor="let edge of graphEdges">
                        <div *ngIf="edge.labelFormatted"
                             class="edge-label-text"
                             [style.left.px]="edge.labelPos?.x"
                             [style.top.px]="edge.labelPos?.y">
                          {{ edge.labelFormatted }}
                        </div>
                      </ng-container>
                    </div>
                    
                    <!-- Nodes - Â§çÂàªÂõæ1Ê†∑Âºè -->
                    <div *ngFor="let node of graphNodes" 
                         class="dag-node" [attr.data-node-id]="node.id"
                         [ngClass]="{
                           'selected': selectedNode?.id === node.id,
                           'is-top-1': getNodeRank(node) === 1, 
                           'is-top-node': getNodeRank(node) > 0
                         }"
                         [style.left.px]="node.x - (node.width/2)"
                         [style.top.px]="node.y - (node.height/2)"
                         [style.width.px]="node.width"
                         (click)="selectNode(node, $event)">
                      
                      <!-- Header with dynamic color -->
                      <div class="node-header" [ngClass]="getNodeHeaderClass(node)">
                        <!-- Diagnostic warning indicator (left side) -->
                        <div *ngIf="node.has_diagnostic" class="diagnostic-indicator" nbTooltip="ËØ•ËäÇÁÇπÊúâËØäÊñ≠Âª∫ËÆÆ">‚ö†Ô∏è</div>
                        <span class="node-title">{{ node.operator_name }}</span>
                        <!-- Top N mark (right corner) -->
                        <div *ngIf="getNodeRank(node) > 1" class="top-mark" nbTooltip="Top {{ getNodeRank(node) }} ËÄóÊó∂ËäÇÁÇπ"></div>
                      </div>
                      
                      <!-- Body -->
                      <div class="node-body">
                        <div class="node-row id-row">
                          <span>plan_node_id={{ node.plan_node_id }}</span>
                        </div>
                        <!-- Horizontal layout: Time | Percentage (Â§çÂàªÂõæ1) -->
                        <div class="node-row metric-row-horizontal">
                          <span class="time-value">ËÄóÊó∂: {{ formatDurationNs(node.metrics?.operator_total_time) }}</span>
                          <span class="pct-value">{{ node.time_percentage | number:'1.2-2' }}%</span>
                        </div>
                      </div>

                      <!-- Bottom Progress Line -->
                      <div class="node-bottom-progress" *ngIf="getNodeRank(node) !== 1">
                         <div class="progress-bar" [style.width.%]="node.time_percentage" [style.background]="getProgressColor(node)"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Right Panel: Dynamic content based on selection -->
              <div class="resize-handle" (mousedown)="startResizeRight($event)" [class.collapsed]="isRightPanelCollapsed"></div>
              
              <div class="dag-right-panel" [style.width.px]="isRightPanelCollapsed ? 40 : rightPanelWidth" [class.collapsed]="isRightPanelCollapsed">
                
                <!-- Top 10 By Time/Memory Section -->
                <div class="right-section top10-section">
                  <div class="section-header">
                    <span class="title">Top 10 By {{ showMemoryView ? 'Memory' : 'Time' }}</span>
                    <span class="link" (click)="toggleMemoryView()">‚áÑ {{ showMemoryView ? 'Time' : 'Memory' }}</span>
                    <span class="collapse-toggle" (click)="toggleTop10()">{{ isTop10Collapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isTop10Collapsed && !isRightPanelCollapsed">
                    <!-- Time View -->
                    <table class="top10-table" *ngIf="!showMemoryView">
                      <thead>
                        <tr>
                          <th>ËäÇÁÇπ</th>
                          <th>Êó∂Èó¥</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let node of top10NodesByTime; let i = index" 
                            (click)="selectNodeById(node.id)" 
                            [class.selected]="selectedNode?.id === node.id">
                          <td class="node-name">{{ node.operator_name }}</td>
                          <td class="node-time">{{ node.time_percentage | number:'1.2-2' }}%</td>
                        </tr>
                        <tr *ngIf="!top10NodesByTime?.length">
                          <td colspan="2" class="text-center text-hint">ÊöÇÊó†Êï∞ÊçÆ</td>
                        </tr>
                      </tbody>
                    </table>
                    <!-- Memory View -->
                    <table class="top10-table" *ngIf="showMemoryView">
                      <thead>
                        <tr>
                          <th>ËäÇÁÇπ</th>
                          <th>ÂÜÖÂ≠ò</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let node of top10NodesByMemory; let i = index" 
                            (click)="selectNodeById(node.id)" 
                            [class.selected]="selectedNode?.id === node.id">
                          <td class="node-name">{{ node.operator_name }}</td>
                          <td class="node-memory">{{ formatBytes(node.metrics?.memory_usage) }}</td>
                        </tr>
                        <tr *ngIf="!top10NodesByMemory?.length">
                          <td colspan="2" class="text-center text-hint">ÊöÇÊó†Êï∞ÊçÆ</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Summary Section (when no node selected) -->
                <div class="right-section summary-section" *ngIf="!selectedNode">
                  <div class="section-header">
                    <span class="title">ÊÄªËßà</span>
                    <span class="collapse-toggle" (click)="toggleSummary()">{{ isSummaryCollapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isSummaryCollapsed && !isRightPanelCollapsed">
                    <!-- Execution Time Bar -->
                    <div class="summary-row">
                      <span class="label">Execution time</span>
                    </div>
                    <div class="exec-time-bar">
                      <div class="bar-fill io" [style.width.%]="getScanTimePercentage()"></div>
                      <div class="bar-fill processing" [style.width.%]="getCpuTimePercentage()"></div>
                    </div>
                    
                    <!-- IO/Scan Section -->
                    <div class="metric-group">
                      <div class="metric-header">
                        <span class="dot io"></span>
                        <span class="name">Scan Time</span>
                        <span class="value">{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_scan_time, getScanTimePercentage()) }}</span>
                      </div>
                    </div>
                    
                    <!-- Processing/CPU Section -->
                    <div class="metric-group">
                      <div class="metric-header">
                        <span class="dot processing"></span>
                        <span class="name">CPU Time</span>
                        <span class="value">{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_cpu_time, getCpuTimePercentage()) }}</span>
                      </div>
                    </div>
                    
                    <!-- Summary Metrics from backend -->
                    <div class="metrics-list-simple">
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_execution_wall_time">
                        <span class="metric-label">
                          ExecutionWallTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('ExecutionWallTime')" 
                                   *ngIf="getMetricDescription('ExecutionWallTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_execution_wall_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_operator_time">
                        <span class="metric-label">
                          OperatorTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('OperatorTime')" 
                                   *ngIf="getMetricDescription('OperatorTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_cumulative_operator_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_cpu_time">
                        <span class="metric-label">
                          QueryCpuTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('QueryCpuTime')" 
                                   *ngIf="getMetricDescription('QueryCpuTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_cumulative_cpu_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_scan_time">
                        <span class="metric-label">
                          QueryScanTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('QueryScanTime')" 
                                   *ngIf="getMetricDescription('QueryScanTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_cumulative_scan_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_network_time">
                        <span class="metric-label">
                          QueryNetworkTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('QueryNetworkTime')" 
                                   *ngIf="getMetricDescription('QueryNetworkTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_cumulative_network_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_peak_schedule_time">
                        <span class="metric-label">
                          PeakScheduleTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('PeakScheduleTime')" 
                                   *ngIf="getMetricDescription('PeakScheduleTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_peak_schedule_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.result_deliver_time">
                        <span class="metric-label">
                          ResultDeliverTime
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('ResultDeliverTime')" 
                                   *ngIf="getMetricDescription('ResultDeliverTime')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.result_deliver_time }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_sum_memory_usage">
                        <span class="metric-label">
                          MemoryUsage
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('MemoryUsage')" 
                                   *ngIf="getMetricDescription('MemoryUsage')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_sum_memory_usage }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_spill_bytes">
                        <span class="metric-label">
                          SpillBytes
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('SpillBytes')" 
                                   *ngIf="getMetricDescription('SpillBytes')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_spill_bytes }}</span>
                      </div>
                      <!-- DataCache Hit Rate (for disaggregated storage-compute clusters) -->
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.datacache_hit_rate != null">
                        <span class="metric-label">
                          DataCacheÂëΩ‰∏≠Áéá
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getDataCacheTooltip()"
                                   nbTooltipPlacement="left"></nb-icon>
                        </span>
                        <span [class.text-success]="analysisData?.summary?.datacache_hit_rate >= 0.7"
                              [class.text-warning]="analysisData?.summary?.datacache_hit_rate >= 0.3 && analysisData?.summary?.datacache_hit_rate < 0.7"
                              [class.text-danger]="analysisData?.summary?.datacache_hit_rate < 0.3">
                          {{ (analysisData?.summary?.datacache_hit_rate * 100).toFixed(1) }}%
                        </span>
                      </div>
                      <!-- Fallback when no metrics available -->
                      <div *ngIf="!hasAnyMetric()" class="text-hint text-center py-2">
                        ÊöÇÊó†ÊåáÊ†áÊï∞ÊçÆ
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Node Detail Section (when node is selected) -->
                <div class="right-section node-detail-section" *ngIf="selectedNode">
                  <div class="section-header">
                    <span class="title">{{ selectedNode.operator_name }}</span>
                    <span class="collapse-toggle" (click)="clearSelectedNode()">‚úï ÂÖ≥Èó≠</span>
                  </div>
                  <div class="section-body" *ngIf="!isRightPanelCollapsed">
                    <!-- Node Tabs using Nebular -->
                    <nb-tabset class="node-detail-tabs">
                      <!-- CoreMetrics Tab -->
                      <nb-tab tabTitle="CoreMetrics">
                        <div class="metrics-list-simple">
                          <div class="metric-row-simple">
                            <span>plan_node_id</span>
                            <span>{{ selectedNode.plan_node_id }}</span>
                          </div>
                          <div class="metric-row-simple">
                            <span class="metric-label">
                              OperatorTotalTime
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('OperatorTotalTime')" 
                                       *ngIf="getMetricDescription('OperatorTotalTime')"></nb-icon>
                            </span>
                            <span>{{ formatDurationNs(selectedNode.metrics?.operator_total_time) }}</span>
                          </div>
                          <div class="metric-row-simple">
                            <span class="metric-label">
                              TimePercentage
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('TimePercentage')" 
                                       *ngIf="getMetricDescription('TimePercentage')"></nb-icon>
                            </span>
                            <span>{{ selectedNode.time_percentage | number:'1.2-2' }}%</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.rows !== undefined">
                            <span class="metric-label">
                              OutputRows
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('OutputRows')" 
                                       *ngIf="getMetricDescription('OutputRows')"></nb-icon>
                            </span>
                            <span>{{ selectedNode.rows | number }}</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.metrics?.push_row_num">
                            <span class="metric-label">
                              PushRowNum
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('PushRowNum')" 
                                       *ngIf="getMetricDescription('PushRowNum')"></nb-icon>
                            </span>
                            <span>{{ selectedNode.metrics?.push_row_num | number }}</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.metrics?.pull_row_num">
                            <span class="metric-label">
                              PullRowNum
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('PullRowNum')" 
                                       *ngIf="getMetricDescription('PullRowNum')"></nb-icon>
                            </span>
                            <span>{{ selectedNode.metrics?.pull_row_num | number }}</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.metrics?.memory_usage">
                            <span class="metric-label">
                              MemoryUsage
                              <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                       [nbTooltip]="getMetricDescription('PeakMemoryUsage')" 
                                       *ngIf="getMetricDescription('PeakMemoryUsage')"></nb-icon>
                            </span>
                            <span>{{ formatBytes(selectedNode.metrics?.memory_usage) }}</span>
                          </div>
                        </div>
                      </nb-tab>
                      
                      <!-- NodeMetrics Tab (All metrics) -->
                      <nb-tab tabTitle="NodeMetrics">
                        <div class="metrics-list-simple">
                          <!-- All metrics from node.metrics -->
                          <ng-container *ngIf="selectedNode.metrics">
                            <div class="metric-row-simple" *ngFor="let key of getMetricKeys(selectedNode.metrics)">
                              <span class="metric-label">
                                {{ key }}
                                <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                         [nbTooltip]="getMetricDescription(key)" 
                                         *ngIf="getMetricDescription(key)"></nb-icon>
                              </span>
                              <span>{{ formatMetricValue(key, selectedNode.metrics[key]) }}</span>
                            </div>
                          </ng-container>
                          <!-- Unique metrics -->
                          <ng-container *ngIf="selectedNode.unique_metrics">
                            <div class="metric-row-simple" *ngFor="let key of objectKeys(selectedNode.unique_metrics)">
                              <span class="metric-label">
                                {{ key }}
                                <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                         [nbTooltip]="getMetricDescription(key)" 
                                         *ngIf="getMetricDescription(key)"></nb-icon>
                              </span>
                              <span>{{ selectedNode.unique_metrics[key] }}</span>
                            </div>
                          </ng-container>
                          <div *ngIf="!selectedNode.metrics && !selectedNode.unique_metrics" class="text-hint text-center py-2">
                            ÊöÇÊó†ËØ¶ÁªÜÊåáÊ†á
                          </div>
                        </div>
                      </nb-tab>
                      
                      <!-- Pipeline Tab -->
                      <nb-tab tabTitle="Pipeline">
                        <div class="metrics-list-simple">
                          <div class="metric-row-simple" *ngIf="selectedNode.fragment_id">
                            <span>FragmentID</span>
                            <span>{{ selectedNode.fragment_id }}</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.pipeline_id">
                            <span>PipelineID</span>
                            <span>{{ selectedNode.pipeline_id }}</span>
                          </div>
                          <div class="metric-row-simple">
                            <span>Depth</span>
                            <span>{{ selectedNode.depth }}</span>
                          </div>
                          <div class="metric-row-simple">
                            <span>NodeType</span>
                            <span>{{ selectedNode.node_type }}</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.is_hotspot">
                            <span>IsHotspot</span>
                            <span class="badge badge-danger">Yes</span>
                          </div>
                          <div class="metric-row-simple" *ngIf="selectedNode.hotspot_severity && selectedNode.hotspot_severity !== 'Normal'">
                            <span>HotspotSeverity</span>
                            <span>{{ selectedNode.hotspot_severity }}</span>
                          </div>
                          <div *ngIf="!selectedNode.fragment_id && !selectedNode.pipeline_id" class="text-hint text-center py-2">
                            Pipeline ‰ø°ÊÅØÊöÇ‰∏çÂèØÁî®
                          </div>
                        </div>
                      </nb-tab>
                    </nb-tabset>
                  </div>
                </div>

                <!-- Diagnosis Section - Context-aware (Node-specific or Aggregated) -->
                <div class="right-section diagnosis-section">
                  <div class="section-header">
                    <span class="title">{{ selectedNode ? 'ËäÇÁÇπËØäÊñ≠' : 'ËØäÊñ≠Âª∫ËÆÆ' }}</span>
                    <span class="warning-badge" *ngIf="getCurrentDiagnosticsCount()">{{ getCurrentDiagnosticsCount() }}</span>
                    <span class="collapse-toggle" (click)="toggleDiagnosis()">{{ isDiagnosisCollapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isDiagnosisCollapsed && !isRightPanelCollapsed">
                    
                    <!-- When node is selected: show node-specific diagnostics -->
                    <ng-container *ngIf="selectedNode">
                      <div *ngIf="getNodeDiagnostics(selectedNode)?.length" class="diagnosis-list">
                        <div *ngFor="let diag of getNodeDiagnostics(selectedNode)" class="diagnosis-item-detailed">
                          <div class="diag-header">
                            <span class="diag-badge" [ngClass]="{
                              'badge-danger': diag.severity === 'Error',
                              'badge-warning': diag.severity === 'Warning',
                              'badge-info': diag.severity === 'Info'
                            }">{{ diag.rule_id }}</span>
                            <span class="diag-name">{{ diag.rule_name }}</span>
                          </div>
                          <div class="diag-message">{{ diag.message }}</div>
                          <div class="diag-reason" *ngIf="diag.reason">
                            <nb-icon icon="info-outline" class="text-info"></nb-icon>
                            <span class="reason-text">{{ diag.reason }}</span>
                          </div>
                          <div class="diag-suggestions" *ngIf="diag.suggestions?.length">
                            <div *ngFor="let suggestion of diag.suggestions" class="diag-suggestion">
                              <span class="icon">üí°</span>
                              <span>{{ suggestion }}</span>
                            </div>
                          </div>
                          <div class="diag-params" *ngIf="diag.parameter_suggestions?.length">
                            <div *ngFor="let param of diag.parameter_suggestions" class="param-item">
                              <div class="param-header">
                                <nb-icon icon="settings-2-outline" class="text-primary"></nb-icon>
                                <span class="param-name">{{ param.name }}</span>
                                <span class="param-type badge badge-basic">{{ param.param_type }}</span>
                              </div>
                              <div class="param-description" *ngIf="param.description">
                                <span class="text-hint">{{ param.description }}</span>
                              </div>
                              <div class="param-impact" *ngIf="param.impact">
                                <nb-icon icon="trending-up-outline" class="text-success"></nb-icon>
                                <span class="impact-text">{{ param.impact }}</span>
                              </div>
                              <div class="param-value-row">
                                <span class="text-hint" *ngIf="param.current">ÂΩìÂâçÂÄº: <code>{{ param.current }}</code> ‚Üí</span>
                                <span class="text-hint">Êé®ËçêÂÄº:</span>
                                <code class="recommended-value">{{ param.recommended }}</code>
                              </div>
                              <div class="param-command" *ngIf="param.command">
                                <code class="command-text" (click)="copyToClipboard(param.command)" nbTooltip="ÁÇπÂáªÂ§çÂà∂">{{ param.command }}</code>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div *ngIf="!getNodeDiagnostics(selectedNode)?.length" class="empty-diagnosis">
                        ËØ•ËäÇÁÇπÊöÇÊó†ËØäÊñ≠Âª∫ËÆÆ
                      </div>
                    </ng-container>

                    <!-- When no node selected: show aggregated diagnostics -->
                    <ng-container *ngIf="!selectedNode">
                      <div *ngIf="analysisData?.aggregated_diagnostics?.length" class="diagnosis-list">
                        <div *ngFor="let diag of analysisData?.aggregated_diagnostics" class="diagnosis-item-detailed">
                          <div class="diag-header">
                            <span class="diag-badge" [ngClass]="{
                              'badge-danger': diag.severity === 'Error',
                              'badge-warning': diag.severity === 'Warning',
                              'badge-info': diag.severity === 'Info'
                            }">{{ diag.rule_id }}</span>
                            <span class="diag-name">{{ diag.rule_name }}</span>
                            <span class="node-count-badge" *ngIf="diag.node_count > 1">√ó{{ diag.node_count }} ‰∏™ËäÇÁÇπ</span>
                          </div>
                          <div class="diag-message">{{ diag.message }}</div>
                          <div class="diag-reason" *ngIf="diag.reason">
                            <nb-icon icon="info-outline" class="text-info"></nb-icon>
                            <span class="reason-text">{{ diag.reason }}</span>
                          </div>
                          <div class="diag-affected-nodes" *ngIf="diag.affected_nodes?.length">
                            <nb-icon icon="pin-outline" class="text-hint"></nb-icon>
                            <span class="text-hint">Ê∂âÂèäËäÇÁÇπ: {{ diag.affected_nodes.join(', ') }}</span>
                          </div>
                          <div class="diag-suggestions" *ngIf="diag.suggestions?.length">
                            <div *ngFor="let suggestion of diag.suggestions" class="diag-suggestion">
                              <span class="icon">üí°</span>
                              <span>{{ suggestion }}</span>
                            </div>
                          </div>
                          <div class="diag-params" *ngIf="diag.parameter_suggestions?.length">
                            <div *ngFor="let param of diag.parameter_suggestions" class="param-item">
                              <div class="param-header">
                                <nb-icon icon="settings-2-outline" class="text-primary"></nb-icon>
                                <span class="param-name">{{ param.name }}</span>
                                <span class="param-type badge badge-basic">{{ param.param_type }}</span>
                              </div>
                              <div class="param-description" *ngIf="param.description">
                                <span class="text-hint">{{ param.description }}</span>
                              </div>
                              <div class="param-impact" *ngIf="param.impact">
                                <nb-icon icon="trending-up-outline" class="text-success"></nb-icon>
                                <span class="impact-text">{{ param.impact }}</span>
                              </div>
                              <div class="param-value-row">
                                <span class="text-hint" *ngIf="param.current">ÂΩìÂâçÂÄº: <code>{{ param.current }}</code> ‚Üí</span>
                                <span class="text-hint">Êé®ËçêÂÄº:</span>
                                <code class="recommended-value">{{ param.recommended }}</code>
                              </div>
                              <div class="param-command" *ngIf="param.command">
                                <code class="command-text" (click)="copyToClipboard(param.command)" nbTooltip="ÁÇπÂáªÂ§çÂà∂">{{ param.command }}</code>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div *ngIf="!analysisData?.aggregated_diagnostics?.length && analysisData?.suggestions?.length" class="diagnosis-list">
                        <div *ngFor="let suggestion of analysisData?.suggestions" class="diagnosis-item">
                          <span class="icon">üí°</span>
                          <span class="text">{{ suggestion }}</span>
                        </div>
                      </div>
                      <div *ngIf="!analysisData?.aggregated_diagnostics?.length && !analysisData?.suggestions?.length" class="empty-diagnosis">
                        ÊöÇÊó†ËØäÊñ≠Âª∫ËÆÆ
                      </div>
                    </ng-container>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </nb-tab>
        
        <!-- Tab 2: Profile ÂéüÂßãÊñáÊú¨ -->
        <nb-tab tabTitle="ProfileËØ¶ÊÉÖ" tabIcon="file-text-outline">
          <nb-card accent="basic" class="m-0">
            <nb-card-body class="profile-scroll-container position-relative">
              <div *ngIf="profileDetailLoading" class="text-center py-4">
                <nb-spinner status="primary" size="large"></nb-spinner>
                <p class="mt-3 text-hint">Âä†ËΩΩ Profile ËØ¶ÊÉÖ‰∏≠...</p>
              </div>

              <div class="profile-copy-overlay" *ngIf="!profileDetailLoading" style="position: absolute; top: 0.5rem; right: 0.5rem; left: auto; z-index: 10;">
                <button
                  nbButton
                  status="basic"
                  size="small"
                  (click)="copyProfileToClipboard()"
                  [disabled]="!currentProfileDetail"
                  nbTooltip="Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø"
                  nbTooltipPlacement="left"
                >
                  <nb-icon icon="copy-outline"></nb-icon>
                </button>
              </div>
              <div *ngIf="!profileDetailLoading" class="profile-pre-wrapper">
                <div *ngIf="!currentProfileDetail || currentProfileDetail.trim() === ''" class="text-center py-4 text-hint">
                  <nb-icon icon="file-text-outline" status="basic" class="mb-2"></nb-icon>
                  <p>ÊöÇÊó† Profile Êï∞ÊçÆ</p>
                </div>
                <pre *ngIf="currentProfileDetail && currentProfileDetail.trim() !== ''" class="profile-content-text">{{ currentProfileDetail }}</pre>
              </div>
            </nb-card-body>
          </nb-card>
        </nb-tab>
      </nb-tabset>
    </nb-card-body>
  </nb-card>
</ng-template>
