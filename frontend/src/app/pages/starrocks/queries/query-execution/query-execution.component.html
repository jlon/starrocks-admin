<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-body>
        <!-- Tab Selector -->
        <nb-tabset (changeTab)="selectTab($event.tabId)">
          <!-- Real-time Query Tab -->
          <nb-tab tabTitle="实时查询" tabId="realtime" [active]="selectedTab === 'realtime'">
            <div class="realtime-query-container">
              <!-- SQL Editor - CodeMirror -->
              <div class="sql-editor-section">
                <!-- Catalog and Database Selection with Action Buttons on Right -->
                <div class="catalog-database-selector mb-1 d-flex justify-content-between align-items-center gap-3">
                  <div class="d-flex align-items-center gap-2">
                    <nb-select 
                      [(selected)]="selectedCatalog" 
                      (selectedChange)="onCatalogChange($event)"
                      placeholder="选择 Catalog"
                      size="small"
                      [disabled]="executing || loadingCatalogs"
                      style="min-width: 180px;">
                      <nb-option *ngFor="let catalog of catalogs" [value]="catalog">
                        {{ catalog }}
                      </nb-option>
                    </nb-select>
                    
                    <nb-select 
                      [(selected)]="selectedDatabase" 
                      placeholder="{{ loadingDatabases ? '加载中...' : (selectedCatalog ? '选择数据库（可选）' : '请先选择 Catalog') }}"
                      size="small"
                      [disabled]="executing || loadingDatabases || !selectedCatalog"
                      style="min-width: 200px;">
                      <nb-option value="">不使用数据库</nb-option>
                      <nb-option *ngFor="let db of databases" [value]="db">
                        {{ db }}
                      </nb-option>
                      <nb-option *ngIf="!loadingDatabases && selectedCatalog && databases.length === 0" disabled>
                        该 Catalog 下暂无数据库
                      </nb-option>
                    </nb-select>
                  </div>
                  
                  <!-- Action Buttons on Top Right -->
                  <div class="editor-action-buttons d-flex align-items-center gap-2">
                    <button 
                      nbButton 
                      status="primary" 
                      size="small"
                      (click)="executeSQL()" 
                      [disabled]="executing || !clusterId || !sqlInput">
                      <nb-icon icon="play-circle-outline"></nb-icon>
                      {{ executing ? '执行中...' : '执行' }}
                    </button>
                    <button 
                      nbButton 
                      status="basic" 
                      size="small"
                      (click)="clearSQL()" 
                      [disabled]="executing">
                      <nb-icon icon="trash-2-outline"></nb-icon>
                      清空
                    </button>
                    <button 
                      nbButton 
                      status="info" 
                      size="small"
                      (click)="formatSQL()" 
                      [disabled]="executing || !sqlInput">
                      <nb-icon icon="code-outline"></nb-icon>
                      格式化
                    </button>
                  </div>
                </div>

                <!-- CodeMirror Editor Container -->
                <div #editorContainer class="codemirror-container"></div>
                
                <div class="editor-toolbar mt-2 d-flex justify-content-end align-items-center">
                  <div class="right-actions">
                    <span class="limit-label">限制:</span>
                    <nb-select 
                      [(selected)]="queryLimit" 
                      size="tiny"
                      [disabled]="executing">
                      <nb-option *ngFor="let option of limitOptions" [value]="option.value">
                        {{ option.label }}
                      </nb-option>
                    </nb-select>
                  </div>
                </div>
                
                <small class="hint-text mt-2">
                  <nb-icon icon="info-outline"></nb-icon>
                  SELECT 查询会自动添加 LIMIT 限制（如未指定）
                </small>
              </div>

              <!-- Query Result -->
              <nb-card *ngIf="queryResult" class="mt-3">
                <nb-card-header>
                  <div class="result-header">
                    <h6 class="mb-0">查询结果</h6>
                    <div class="result-actions">
                      <div class="result-stat-item">
                        <nb-icon icon="clock-outline" status="success" class="stat-icon"></nb-icon>
                        <span class="stat-label">执行耗时:</span>
                        <span class="stat-value stat-time">{{ executionTime }}ms</span>
                      </div>
                      <div class="result-stat-item">
                        <nb-icon icon="list-outline" status="info" class="stat-icon"></nb-icon>
                        <span class="stat-label">返回行数:</span>
                        <span class="stat-value stat-count">{{ rowCount | number }}</span>
                      </div>
                      <button 
                        nbButton 
                        size="small" 
                        status="success"
                        (click)="exportResults()"
                        class="ml-2">
                        <nb-icon icon="download-outline"></nb-icon>
                        导出 CSV
                      </button>
                    </div>
                  </div>
                </nb-card-header>
                <nb-card-body>
                  <ng2-smart-table 
                    *ngIf="resultSettings" 
                    [settings]="resultSettings" 
                    [source]="realtimeResultSource">
                  </ng2-smart-table>
                  <div *ngIf="rowCount === 0" class="no-data-message">
                    <nb-icon icon="inbox-outline"></nb-icon>
                    <p>查询未返回任何数据</p>
                  </div>
                </nb-card-body>
              </nb-card>
            </div>
          </nb-tab>

          <!-- Running Queries Tab -->
          <nb-tab tabTitle="运行中" tabId="running" [active]="selectedTab === 'running'">
            <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary"></nb-spinner></div>
            <ng2-smart-table 
              *ngIf="!loading" 
              [settings]="runningSettings" 
              [source]="runningSource">
            </ng2-smart-table>
          </nb-tab>
        </nb-tabset>
      </nb-card-body>
    </nb-card>
  </div>
</div>
