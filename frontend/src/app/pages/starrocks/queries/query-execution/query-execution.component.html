<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-body>
        <!-- Tab Selector with Toggle Button -->
        <div class="tab-header-wrapper">
          <div class="tab-header-with-toggle">
            <nb-tabset (changeTab)="selectTab($event.tabId)">
              <!-- Real-time Query Tab -->
              <nb-tab tabTitle="实时查询" tabId="realtime" [active]="selectedTab === 'realtime'">
            <div class="realtime-query-container">
              <div class="query-split-layout">
                <div class="nav-tree-wrapper" [class.collapsed]="treeCollapsed" [style.width.px]="treePanelWidth">
                  <ng-container *ngIf="!treeCollapsed; else collapsedButton">
                    <nb-card size="tiny" class="nav-tree-card" [style.height.px]="treePanelHeight">
                      <nb-card-header>
                        <div class="nav-tree-header">
                          <nb-icon icon="layers-outline"></nb-icon>
                          <span>Catalog / 数据库</span>
                        </div>
                        <button 
                          nbButton 
                          status="basic"
                          size="tiny" 
                          class="tree-collapse-toggle header-button"
                          type="button"
                          (click)="toggleTreeCollapsed()"
                          [title]="treeCollapsed ? '展开数据库树' : '收起数据库树'">
                          <nb-icon icon="arrow-ios-back-outline"></nb-icon>
                        </button>
                      </nb-card-header>
                      <nb-card-body>
                        <div class="tree-scroll">
                          <div class="tree-loading" *ngIf="loadingCatalogs">
                            <nb-spinner size="small" status="primary"></nb-spinner>
                          </div>
                          <ul class="nav-tree" *ngIf="!loadingCatalogs && databaseTree.length > 0; else emptyTree">
                            <ng-container *ngFor="let node of databaseTree; trackBy: trackNodeById">
                              <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: node }"></ng-container>
                            </ng-container>
                          </ul>
                          <ng-template #emptyTree>
                            <div class="empty-tree">
                              <nb-icon icon="alert-circle-outline"></nb-icon>
                              <span>暂无 Catalog</span>
                            </div>
                          </ng-template>
                        </div>
                      </nb-card-body>
                    </nb-card>
                  </ng-container>
                  <ng-template #collapsedButton>
                    <button 
                      nbButton 
                      status="basic"
                      size="tiny" 
                      class="tree-collapse-toggle collapsed-button"
                      type="button"
                      (click)="toggleTreeCollapsed()"
                      [title]="treeCollapsed ? '展开数据库树' : '收起数据库树'">
                      <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                    </button>
                  </ng-template>
                </div>

                <div class="tree-resizer" *ngIf="!treeCollapsed" (mousedown)="startTreeResize($event)">
                  <span class="resizer-grip"></span>
                </div>

                <div class="editor-panel">
                  <!-- Collapsed SQL Bar (shown when editor is collapsed) -->
                  <div *ngIf="sqlEditorCollapsed" class="collapsed-sql-bar" (click)="toggleSqlEditor(false)">
                    <div class="collapsed-sql-preview">
                      <nb-icon icon="code-outline" status="primary"></nb-icon>
                      <span class="sql-text" *ngIf="sqlInput && sqlInput.length > 0">{{ sqlInput | slice:0:100 }}{{ sqlInput.length > 100 ? '...' : '' }}</span>
                      <span class="sql-text sql-placeholder" *ngIf="!sqlInput || sqlInput.length === 0">点击展开 SQL 编辑器</span>
                    </div>
                  </div>

                  <!-- SQL Editor - CodeMirror (shown when editor is expanded) -->
                  <div class="sql-editor-section" [@editorCollapse]="sqlEditorCollapsed ? 'collapsed' : 'expanded'">
                    <div class="selection-toolbar d-flex justify-content-between align-items-center">
                      <div class="selection-path d-flex align-items-center">
                        <nb-icon icon="pin-outline" status="primary"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedCatalog">{{ selectedCatalog || '未选择 Catalog' }}</span>
                        <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedDatabase">{{ selectedDatabase || '未选择数据库' }}</span>
                        <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedTable">{{ selectedTable || '未选择表' }}</span>
                        <nb-spinner *ngIf="loadingDatabases" size="tiny" status="info" class="loading-indicator"></nb-spinner>
                      </div>

                      <div class="editor-action-buttons d-flex align-items-center gap-2">
                        <button 
                          nbButton 
                          status="primary" 
                          size="small"
                          [nbSpinner]="executing"
                          nbSpinnerStatus="control"
                          nbSpinnerSize="small"
                          (click)="executeSQL()" 
                          [disabled]="executing || !clusterId || !sqlInput">
                          <nb-icon *ngIf="!executing" icon="play-circle-outline"></nb-icon>
                          {{ executing ? '执行中...' : '执行' }}
                        </button>
                        <button 
                          nbButton 
                          status="basic" 
                          size="small"
                          (click)="clearSQL()" 
                          [disabled]="executing">
                          <nb-icon icon="trash-2-outline"></nb-icon>
                          清空
                        </button>
                        <button 
                          nbButton 
                          status="info" 
                          size="small"
                          (click)="formatSQL()" 
                          [disabled]="executing || !sqlInput">
                          <nb-icon icon="code-outline"></nb-icon>
                          格式化
                        </button>
                      </div>
                    </div>

                    <!-- CodeMirror Editor Container -->
                    <div class="editor-wrapper">
                      <div #editorContainer class="codemirror-container"></div>

                      <!-- Loading overlay with Nebular spinner -->
                      <div *ngIf="executing" class="loading-overlay">
                        <nb-spinner size="large" status="primary" message="正在执行查询..."></nb-spinner>
                      </div>
                    </div>

                    <div class="editor-toolbar mt-2 d-flex justify-content-between align-items-center">
                      <small class="hint-text">
                        <nb-icon icon="info-outline"></nb-icon>
                        SELECT 查询会自动添加 LIMIT 限制（如未指定）
                      </small>

                      <div class="right-actions">
                        <span class="limit-label">限制:</span>
                        <nb-select 
                          [(selected)]="queryLimit" 
                          size="tiny"
                          [disabled]="executing">
                          <nb-option *ngFor="let option of limitOptions" [value]="option.value">
                            {{ option.label }}
                          </nb-option>
                        </nb-select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <ng-template #treeNodeTemplate let-node>
                <li class="tree-node" [class.expanded]="node.expanded" [class.selected]="node.id === selectedNodeId">
                  <div class="tree-node-row" [ngClass]="'type-' + node.type" [style.paddingLeft.px]="getNodeIndent(node)" (click)="onNodeSelect(node, $event)">
                    <button 
                      *ngIf="isNodeExpandable(node)"
                      nbButton 
                      ghost 
                      size="tiny" 
                      class="toggle-btn"
                      type="button"
                      (click)="toggleNode(node, $event)"
                      [class.expanded]="node.expanded">
                      <nb-icon [icon]="node.expanded ? 'chevron-down-outline' : 'chevron-right-outline'"></nb-icon>
                    </button>
                    <div class="node-icon">
                      <nb-icon [icon]="node.icon || 'folder-outline'"></nb-icon>
                    </div>
                    <span class="node-text">{{ node.name }}</span>
                    <nb-spinner *ngIf="node.loading" size="tiny" status="primary"></nb-spinner>
                  </div>
                  <ul class="tree-children" *ngIf="node.children && node.children.length && node.expanded">
                    <ng-container *ngFor="let child of node.children; trackBy: trackNodeById">
                      <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: child }"></ng-container>
                    </ng-container>
                  </ul>
                </li>
              </ng-template>

              <!-- Query Results -->
              <div *ngIf="queryResult" class="mt-3">
                <!-- Single Result (when only 1 SQL) -->
                <nb-card *ngIf="queryResults.length === 1" class="result-card">
                  <nb-card-header>
                    <div class="result-header">
                      <h6 class="mb-0">查询结果</h6>
                      <div class="result-actions">
                        <div class="result-stat-item">
                          <nb-icon icon="clock-outline" status="success" class="stat-icon"></nb-icon>
                          <span class="stat-label">执行耗时:</span>
                          <span class="stat-value stat-time">{{ executionTime }}ms</span>
                        </div>
                        <div class="result-stat-item">
                          <nb-icon icon="list-outline" status="info" class="stat-icon"></nb-icon>
                          <span class="stat-label">返回行数:</span>
                          <span class="stat-value stat-count">{{ rowCount | number }}</span>
                        </div>
                        <button 
                          *ngIf="queryResults[0].success"
                          nbButton 
                          size="small" 
                          status="success"
                          (click)="exportResults(0)"
                          class="ml-2">
                          <nb-icon icon="download-outline"></nb-icon>
                          导出 CSV
                        </button>
                      </div>
                    </div>
                  </nb-card-header>
                  <nb-card-body>
                    <div *ngIf="queryResults[0].error" class="error-message mb-3">
                      <nb-alert status="danger" [title]="'执行失败'">{{ queryResults[0].error }}</nb-alert>
                    </div>
                    <ng2-smart-table 
                      *ngIf="resultSettings[0] && queryResults[0].success" 
                      [settings]="resultSettings[0]" 
                      [source]="resultSources[0]">
                    </ng2-smart-table>
                    <div *ngIf="queryResults[0].success && rowCount === 0" class="no-data-message">
                      <nb-icon icon="inbox-outline"></nb-icon>
                      <p>查询未返回任何数据</p>
                    </div>
                  </nb-card-body>
                </nb-card>

                <!-- Multiple Results (using nb-tabset) -->
                <nb-card *ngIf="queryResults.length > 1" class="result-card">
                  <nb-card-body>
                    <div class="tabset-with-export">
                    <nb-tabset #tabsetRef class="result-tabset" (changeTab)="currentResultIndex = $event.tabId ? parseInt($event.tabId.split('-')[1]) : 0">
                      <nb-tab 
                        *ngFor="let result of queryResults; let i = index" 
                        [tabTitle]="'结果' + (i + 1)"
                        [tabId]="'result-' + i"
                        [active]="i === 0">
                          <div class="tab-content-wrapper">
                          
                          <!-- Error Message -->
                          <div *ngIf="result.error" class="error-message mb-3">
                            <nb-alert status="danger" [title]="'执行失败'">{{ result.error }}</nb-alert>
                          </div>
                          
                          <!-- Result Table -->
                          <ng2-smart-table 
                            *ngIf="resultSettings[i] && result.success" 
                            [settings]="resultSettings[i]" 
                            [source]="resultSources[i]">
                          </ng2-smart-table>
                          
                          <!-- Result Stats at bottom right -->
                          <div *ngIf="result.success" class="result-stats-footer">
                            <span class="stats-text">
                              <nb-icon icon="list-outline" class="stats-icon"></nb-icon>
                              {{ result.row_count }} 行
                              <span class="stats-separator">|</span>
                              <nb-icon icon="clock-outline" class="stats-icon"></nb-icon>
                              {{ result.execution_time_ms }}ms
                            </span>
                          </div>
                          
                          <!-- No Data Message -->
                          <div *ngIf="result.success && result.row_count === 0" class="no-data-message">
                            <nb-icon icon="inbox-outline"></nb-icon>
                            <p>查询未返回任何数据</p>
                          </div>
                        </div>
                      </nb-tab>
                    </nb-tabset>
                    
                    <!-- Export button aligned with tabs -->
                    <div class="export-button-wrapper" *ngIf="queryResults.length > 0 && queryResults[currentResultIndex]?.success && queryResults[currentResultIndex]?.row_count > 0">
                      <button 
                        nbButton 
                        size="small" 
                        status="success"
                        (click)="exportResults(currentResultIndex)"
                        class="export-btn">
                        <nb-icon icon="download-outline" class="export-icon"></nb-icon>
                        导出 CSV
                      </button>
                    </div>
                  </div>
                  </nb-card-body>
                </nb-card>
              </div>
            </div>
          </nb-tab>

          <!-- Running Queries Tab -->
          <nb-tab tabTitle="运行中" tabId="running" [active]="selectedTab === 'running'">
            <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary"></nb-spinner></div>
            <ng2-smart-table 
              *ngIf="!loading" 
              [settings]="runningSettings" 
              [source]="runningSource">
            </ng2-smart-table>
          </nb-tab>
          </nb-tabset>
          </div>
          
          <!-- SQL Editor Toggle Button (only visible on realtime tab) -->
          <button 
            *ngIf="selectedTab === 'realtime'"
            nbButton 
            ghost 
            size="tiny"
            (click)="toggleSqlEditor()"
            class="sql-editor-toggle-btn"
            [title]="sqlEditorCollapsed ? '展开 SQL 编辑器' : '收起 SQL 编辑器'">
            <nb-icon [icon]="sqlEditorCollapsed ? 'chevron-down-outline' : 'chevron-up-outline'"></nb-icon>
          </button>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>
