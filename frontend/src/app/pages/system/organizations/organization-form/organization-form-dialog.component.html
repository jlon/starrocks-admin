<nb-card class="organization-dialog">
  <nb-card-header>
    <div class="dialog-header">
      <div>
        <h5>{{ mode === 'create' ? '创建组织' : '编辑组织' }}</h5>
        <p class="dialog-subtitle">
          {{ mode === 'create' ? '创建新组织并指定管理员' : '修改组织信息' }}
        </p>
      </div>
      <button nbButton ghost status="basic" (click)="cancel()">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <form [formGroup]="form" class="organization-form" novalidate>
      <div class="form-container">
        <!-- Code (only in create mode) -->
        <div class="form-group" *ngIf="mode === 'create'">
          <label class="label" for="input-code">组织代码</label>
          <nb-form-field>
            <nb-icon nbPrefix icon="hash-outline"></nb-icon>
            <input
              nbInput
              fullWidth
              id="input-code"
              placeholder="请输入组织代码（小写字母、数字、下划线）"
              formControlName="code"
              [status]="form.get('code')?.invalid && form.get('code')?.touched ? 'danger' : 'basic'"
              maxlength="50"
            />
          </nb-form-field>
          <ng-container *ngIf="form.get('code')?.invalid && form.get('code')?.touched">
            <p class="caption status-danger" *ngIf="form.get('code')?.errors?.['required']">
              组织代码不能为空
            </p>
            <p class="caption status-danger" *ngIf="form.get('code')?.errors?.['pattern']">
              组织代码只能包含小写字母、数字和下划线
            </p>
          </ng-container>
        </div>

        <!-- Name -->
        <div class="form-group">
          <label class="label" for="input-name">组织名称</label>
          <nb-form-field>
            <nb-icon nbPrefix icon="briefcase-outline"></nb-icon>
            <input
              nbInput
              fullWidth
              id="input-name"
              placeholder="请输入组织名称"
              formControlName="name"
              [status]="form.get('name')?.invalid && form.get('name')?.touched ? 'danger' : 'basic'"
              maxlength="100"
            />
          </nb-form-field>
          <ng-container *ngIf="form.get('name')?.invalid && form.get('name')?.touched">
            <p class="caption status-danger" *ngIf="form.get('name')?.errors?.['required']">
              组织名称不能为空
            </p>
          </ng-container>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label class="label" for="input-description">描述</label>
          <nb-form-field>
            <nb-icon nbPrefix icon="file-text-outline"></nb-icon>
            <textarea
              nbInput
              fullWidth
              id="input-description"
              placeholder="请输入组织描述（可选）"
              formControlName="description"
              rows="3"
              maxlength="500"
            ></textarea>
          </nb-form-field>
        </div>

        <!-- Admin Section (only in create mode) -->
        <div class="form-group" *ngIf="mode === 'create'">
          <label class="label">组织管理员</label>
          <nb-radio-group formControlName="adminMode">
            <nb-radio value="create">创建新管理员</nb-radio>
            <nb-radio value="existing">选择现有用户</nb-radio>
          </nb-radio-group>

          <!-- Create New Admin -->
          <div *ngIf="adminMode === 'create'" class="admin-form-section">
            <div class="form-group">
              <label class="label" for="input-admin-username">管理员用户名</label>
              <nb-form-field>
                <nb-icon nbPrefix icon="person-outline"></nb-icon>
                <input
                  nbInput
                  fullWidth
                  id="input-admin-username"
                  placeholder="请输入管理员用户名"
                  formControlName="admin_username"
                  [status]="form.get('admin_username')?.invalid && form.get('admin_username')?.touched ? 'danger' : 'basic'"
                  maxlength="50"
                />
              </nb-form-field>
              <ng-container *ngIf="form.get('admin_username')?.invalid && form.get('admin_username')?.touched">
                <p class="caption status-danger" *ngIf="form.get('admin_username')?.errors?.['required']">
                  管理员用户名不能为空
                </p>
              </ng-container>
            </div>

            <div class="form-group">
              <label class="label" for="input-admin-password">管理员密码</label>
              <nb-form-field>
                <nb-icon nbPrefix icon="lock-outline"></nb-icon>
                <input
                  nbInput
                  fullWidth
                  type="password"
                  id="input-admin-password"
                  placeholder="请输入管理员密码（至少6个字符）"
                  formControlName="admin_password"
                  [status]="form.get('admin_password')?.invalid && form.get('admin_password')?.touched ? 'danger' : 'basic'"
                />
              </nb-form-field>
              <ng-container *ngIf="form.get('admin_password')?.invalid && form.get('admin_password')?.touched">
                <p class="caption status-danger" *ngIf="form.get('admin_password')?.errors?.['required']">
                  管理员密码不能为空
                </p>
                <p class="caption status-danger" *ngIf="form.get('admin_password')?.errors?.['minlength']">
                  密码至少需要6个字符
                </p>
              </ng-container>
            </div>

            <div class="form-group">
              <label class="label" for="input-admin-email">管理员邮箱</label>
              <nb-form-field>
                <nb-icon nbPrefix icon="email-outline"></nb-icon>
                <input
                  nbInput
                  fullWidth
                  type="email"
                  id="input-admin-email"
                  placeholder="请输入管理员邮箱（可选）"
                  formControlName="admin_email"
                  [status]="form.get('admin_email')?.invalid && form.get('admin_email')?.touched ? 'danger' : 'basic'"
                  maxlength="100"
                />
              </nb-form-field>
              <ng-container *ngIf="form.get('admin_email')?.invalid && form.get('admin_email')?.touched">
                <p class="caption status-danger" *ngIf="form.get('admin_email')?.errors?.['email']">
                  请输入有效的邮箱地址
                </p>
              </ng-container>
            </div>
          </div>

          <!-- Select Existing User -->
          <div *ngIf="adminMode === 'existing'" class="admin-form-section">
            <div class="form-group">
              <label class="label" for="input-admin-user-id">选择用户</label>
              <nb-form-field>
                <nb-icon nbPrefix icon="people-outline"></nb-icon>
                <nb-select
                  formControlName="admin_user_id"
                  id="input-admin-user-id"
                  placeholder="请选择现有用户作为管理员"
                  [status]="form.get('admin_user_id')?.invalid && form.get('admin_user_id')?.touched ? 'danger' : 'basic'"
                  fullWidth
                >
                  <nb-option *ngFor="let user of availableUsers$ | async" [value]="user.id">
                    {{ user.username }}
                    <span class="user-email" *ngIf="user.email">({{ user.email }})</span>
                  </nb-option>
                </nb-select>
              </nb-form-field>
              <ng-container *ngIf="form.get('admin_user_id')?.invalid && form.get('admin_user_id')?.touched">
                <p class="caption status-danger" *ngIf="form.get('admin_user_id')?.errors?.['required']">
                  请选择一个用户作为管理员
                </p>
              </ng-container>
              <p class="caption status-hint" *ngIf="(availableUsers$ | async)?.length === 0">
                暂无可用用户（所有用户都已分配到组织）
              </p>
            </div>
          </div>
        </div>
      </div>
    </form>
  </nb-card-body>

  <nb-card-footer>
    <div class="footer-actions">
      <button nbButton ghost status="basic" (click)="cancel()">取消</button>
      <button nbButton status="primary" (click)="submit()" [disabled]="form.invalid">
        {{ mode === 'create' ? '创建组织' : '保存修改' }}
      </button>
    </div>
  </nb-card-footer>
</nb-card>

