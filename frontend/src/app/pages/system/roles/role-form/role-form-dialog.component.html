<nb-card class="role-dialog">
  <nb-card-header>
    <div class="dialog-header">
      <div class="dialog-header__info">
        <div class="dialog-header__title-row">
          <div class="dialog-header__icon" [ngClass]="mode === 'create' ? 'icon--create' : 'icon--edit'">
            <nb-icon [icon]="mode === 'create' ? 'plus-outline' : 'edit-2-outline'"></nb-icon>
          </div>
          <h5>{{ mode === 'create' ? ('roles.create_role' | translate) : ('roles.edit_role' | translate) }}</h5>
        </div>
        <p class="dialog-subtitle">
          {{ mode === 'create' ? ('roles.create_role_subtitle' | translate) : ('roles.edit_role_subtitle' | translate) }}
        </p>
      </div>
      <button nbButton ghost status="basic" (click)="cancel()" class="close-btn">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <form [formGroup]="form" class="role-form" novalidate>
      <div class="form-layout">
        <!-- Left: Role Basic Information -->
        <div class="basic-info-section">
          <label class="section-label">
            <nb-icon icon="settings-2-outline"></nb-icon>
            {{ 'roles.basic_info' | translate }}
          </label>

          <!-- Organization Selection (Super Admin Only) -->
          <div class="form-group" *ngIf="isSuperAdmin">
            <label class="label" for="input-organization">{{ 'roles.organization' | translate }}</label>
            <nb-form-field>
              <nb-icon nbPrefix icon="home-outline"></nb-icon>
              <nb-select
                formControlName="organizationId"
                id="input-organization"
                [placeholder]="'roles.select_organization' | translate"
                fullWidth
              >
                <nb-option *ngFor="let org of organizations" [value]="org.id">
                  {{ org.name }}
                  <span class="org-code" *ngIf="org.code">({{ org.code }})</span>
                </nb-option>
              </nb-select>
            </nb-form-field>
          </div>

          <!-- Organization Display (Org Admin) -->
          <div class="form-group" *ngIf="!isSuperAdmin && currentOrganization">
            <label class="label">{{ 'roles.organization' | translate }}</label>
            <nb-form-field>
              <nb-icon nbPrefix icon="home-outline"></nb-icon>
              <input
                nbInput
                fullWidth
                type="text"
                [value]="currentOrganization.name"
                disabled
              />
            </nb-form-field>
            <p class="caption status-hint">{{ 'roles.org_admin_hint' | translate }}</p>
          </div>

          <div class="form-group">
            <label class="label" for="input-code">{{ 'roles.role_code' | translate }}</label>
            <nb-form-field>
              <nb-icon nbPrefix icon="hash-outline"></nb-icon>
              <input
                nbInput
                fullWidth
                id="input-code"
                formControlName="code"
                [placeholder]="'roles.role_code_placeholder' | translate"
                [readonly]="mode === 'edit'"
                maxlength="50"
              />
            </nb-form-field>
          </div>

          <div class="form-group">
            <label class="label" for="input-name">{{ 'roles.role_name' | translate }}</label>
            <nb-form-field>
              <nb-icon nbPrefix icon="shield-outline"></nb-icon>
              <input
                nbInput
                fullWidth
                id="input-name"
                formControlName="name"
                [placeholder]="'roles.role_name_placeholder' | translate"
                maxlength="50"
              />
            </nb-form-field>
          </div>

          <div class="form-group form-group--grow">
            <label class="label" for="input-description">{{ 'roles.role_description' | translate }}</label>
            <nb-form-field>
              <textarea
                nbInput
                fullWidth
                id="input-description"
                formControlName="description"
                [placeholder]="'roles.role_description_placeholder' | translate"
                rows="3"
                maxlength="200"
              ></textarea>
            </nb-form-field>
          </div>
        </div>

        <!-- Right: Permission Tree Selection -->
        <div class="permission-section">
          <label class="section-label">
            <nb-icon icon="lock-outline"></nb-icon>
            {{ 'roles.menu_permissions' | translate }}
          </label>
          <div class="permission-tree-container">
            <!-- Simple tree structure (inspired by query-execution) -->
            <div class="tree-scroll">
              <ul class="permission-tree" *ngIf="permissionTree.length > 0; else emptyTree">
                <ng-container *ngFor="let node of permissionTree; trackBy: trackNodeById">
                  <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: node }"></ng-container>
                </ng-container>
              </ul>
              
              <ng-template #emptyTree>
                <div class="empty-tree">
                  <nb-icon icon="inbox-outline"></nb-icon>
                  <span>{{ 'roles.no_permissions' | translate }}</span>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- Tree node recursive template (inspired by query-execution) -->
      <ng-template #treeNodeTemplate let-node>
        <li class="tree-node" [class.expanded]="node.expanded">
          <div class="tree-node-row" [style.paddingLeft.px]="getNodeIndent(node)">
            <!-- Icon -->
            <div class="node-icon">
              <nb-icon [icon]="node.icon"></nb-icon>
            </div>

            <!-- Checkbox and text -->
            <nb-checkbox
              class="node-checkbox"
              [checked]="node.checked"
              [indeterminate]="node.indeterminate"
              (checkedChange)="onNodeCheckChange(node, $event)"
              (click)="$event.stopPropagation()"
            >
              <span class="node-text">{{ node.name }}</span>
            </nb-checkbox>

            <!-- Expand/collapse button (right side) -->
            <button
              *ngIf="isNodeExpandable(node)"
              nbButton
              ghost
              size="tiny"
              class="toggle-btn"
              type="button"
              (click)="toggleNode(node, $event)"
              [class.expanded]="node.expanded"
            >
              <nb-icon [icon]="node.expanded ? 'chevron-down-outline' : 'chevron-right-outline'"></nb-icon>
            </button>
          </div>

          <!-- Children (recursive) -->
          <ul class="tree-children" *ngIf="node.children && node.children.length && node.expanded">
            <ng-container *ngFor="let child of node.children; trackBy: trackNodeById">
              <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: child }"></ng-container>
            </ng-container>
          </ul>
        </li>
      </ng-template>
    </form>
  </nb-card-body>

  <nb-card-footer>
    <div class="footer-actions">
      <button nbButton ghost status="basic" (click)="cancel()">{{ 'common.cancel' | translate }}</button>
      <button nbButton status="primary" (click)="submit()" [disabled]="form.invalid">
        {{ 'common.save' | translate }}
      </button>
    </div>
  </nb-card-footer>
</nb-card>
