<div class="row">
  <div class="col-md-12">
    <nb-card>
      <nb-card-header>
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5>{{ 'user_settings.title' | translate }}</h5>
            <small class="text-hint">{{ 'user_settings.subtitle' | translate }}</small>
          </div>
          <button nbButton status="basic" size="small" (click)="onCancel()">
            <nb-icon icon="arrow-back-outline"></nb-icon>
            {{ 'user_settings.back' | translate }}
          </button>
        </div>
      </nb-card-header>

      <nb-card-body>
        <!-- Loading Indicator -->
        <div *ngIf="loading" class="text-center">
          <nb-spinner size="large"></nb-spinner>
        </div>

        <!-- Error Messages -->
        <nb-alert *ngFor="let error of errors" status="danger" closable (close)="errors = []">
          {{ error }}
        </nb-alert>

        <!-- User Settings Form -->
        <form *ngIf="!loading" (ngSubmit)="onSubmit()" #form="ngForm">
          <!-- Avatar Selection - First Section -->
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label class="label">{{ 'user_settings.avatar_label' | translate }}</label>
                
                <!-- Current Avatar Preview -->
                <div class="avatar-preview-section">
                  <div class="current-avatar-large">
                    <img *ngIf="userForm.avatar" [src]="userForm.avatar" [alt]="'user_settings.current_avatar' | translate" class="preview-image">
                    <div *ngIf="!userForm.avatar" class="avatar-placeholder-large">
                      <nb-icon icon="person-outline"></nb-icon>
                    </div>
                  </div>
                </div>

                <!-- Avatar Options Grid -->
                <div class="avatar-options-grid">
                  <div
                    *ngFor="let avatar of availableAvatars; let i = index"
                    class="avatar-option-small"
                    [class.selected]="userForm.avatar === avatar"
                    (click)="selectAvatar(avatar)">
                    <img [src]="avatar" [alt]="'user_settings.avatar_option' | translate" class="option-image">
                  </div>
                </div>

                <!-- Refresh Button -->
                <div class="refresh-section">
                  <button 
                    type="button" 
                    nbButton 
                    status="primary" 
                    size="small"
                    (click)="generateAvatarOptions()">
                    <nb-icon icon="refresh-outline"></nb-icon>
                    {{ 'user_settings.regenerate' | translate }}
                  </button>
                </div>
              </div>
            </div>

            <!-- User Info Section -->
            <div class="col-md-8">
              <!-- Username -->
              <div class="form-group">
                <label class="label" for="input-username">{{ 'user_settings.username_label' | translate }}</label>
                <input 
                  nbInput
                  fullWidth
                  [(ngModel)]="userForm.username"
                  #username="ngModel"
                  id="input-username"
                  name="username"
                  [placeholder]="'user_settings.username_placeholder' | translate"
                  [status]="username.dirty ? (username.invalid ? 'danger' : 'success') : 'basic'"
                  [required]="true"
                  [minlength]="3">
                <ng-container *ngIf="username.invalid && username.touched">
                  <p class="caption status-danger" *ngIf="username.errors?.['required']">
                    {{ 'user_settings.username_required' | translate }}
                  </p>
                  <p class="caption status-danger" *ngIf="username.errors?.['minlength']">
                    {{ 'user_settings.username_minlength' | translate }}
                  </p>
                </ng-container>
              </div>

              <!-- Email -->
              <div class="form-group">
                <label class="label" for="input-email">{{ 'user_settings.email_label' | translate }}</label>
                <input 
                  nbInput
                  fullWidth
                  [(ngModel)]="userForm.email"
                  #email="ngModel"
                  type="email"
                  id="input-email"
                  name="email"
                  [placeholder]="'user_settings.email_placeholder' | translate"
                  [status]="email.dirty ? (email.invalid ? 'danger' : 'success') : 'basic'"
                  [required]="true"
                  pattern="^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$">
                <ng-container *ngIf="email.invalid && email.touched">
                  <p class="caption status-danger" *ngIf="email.errors?.['required']">
                    {{ 'user_settings.email_required' | translate }}
                  </p>
                  <p class="caption status-danger" *ngIf="email.errors?.['pattern']">
                    {{ 'user_settings.email_invalid' | translate }}
                  </p>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Change Password Section -->
          <div class="row mt-3">
            <div class="col-md-12">
              <nb-card>
                <nb-card-header>
                  <div class="d-flex align-items-center justify-content-between">
                    <span>{{ 'user_settings.change_password' | translate }}</span>
                    <button 
                      nbButton 
                      type="button"
                      status="info" 
                      size="small" 
                      (click)="togglePasswordFields()">
                      <nb-icon [icon]="showPasswordFields ? 'eye-off-outline' : 'edit-outline'"></nb-icon>
                      {{ showPasswordFields ? ('user_settings.cancel_change' | translate) : ('user_settings.change_password' | translate) }}
                    </button>
                  </div>
                </nb-card-header>

                <nb-card-body *ngIf="showPasswordFields">
                  <div class="row">
                    <div class="col-md-12">
                      <!-- Current Password -->
                      <div class="form-group">
                        <label class="label" for="input-current-password">{{ 'user_settings.current_password' | translate }}</label>
                        <input 
                          nbInput
                          fullWidth
                          [(ngModel)]="userForm.currentPassword"
                          #currentPassword="ngModel"
                          type="password"
                          id="input-current-password"
                          name="currentPassword"
                          [placeholder]="'user_settings.current_password_placeholder' | translate"
                          [status]="currentPassword.dirty ? (currentPassword.invalid ? 'danger' : 'success') : 'basic'">
                      </div>
                    </div>

                    <div class="col-md-6">
                      <!-- New Password -->
                      <div class="form-group">
                        <label class="label" for="input-new-password">{{ 'user_settings.new_password' | translate }}</label>
                        <input 
                          nbInput
                          fullWidth
                          [(ngModel)]="userForm.newPassword"
                          #newPassword="ngModel"
                          type="password"
                          id="input-new-password"
                          name="newPassword"
                          [placeholder]="'user_settings.new_password_placeholder' | translate"
                          [status]="newPassword.dirty ? (newPassword.invalid ? 'danger' : 'success') : 'basic'"
                          [minlength]="6">
                        <ng-container *ngIf="newPassword.invalid && newPassword.touched">
                          <p class="caption status-danger" *ngIf="newPassword.errors?.['minlength']">
                            {{ 'user_settings.new_password_minlength' | translate }}
                          </p>
                        </ng-container>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <!-- Confirm Password -->
                      <div class="form-group">
                        <label class="label" for="input-confirm-password">{{ 'user_settings.confirm_password' | translate }}</label>
                        <input 
                          nbInput
                          fullWidth
                          [(ngModel)]="userForm.confirmPassword"
                          #confirmPassword="ngModel"
                          type="password"
                          id="input-confirm-password"
                          name="confirmPassword"
                          [placeholder]="'user_settings.confirm_password_placeholder' | translate"
                          [status]="confirmPassword.dirty ? (confirmPassword.invalid ? 'danger' : 'success') : 'basic'">
                        <ng-container *ngIf="userForm.newPassword !== userForm.confirmPassword && confirmPassword.touched">
                          <p class="caption status-danger">
                            {{ 'user_settings.password_mismatch' | translate }}
                          </p>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                </nb-card-body>
              </nb-card>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row mt-3">
            <div class="col-md-12">
              <div class="d-flex justify-content-end">
                <button 
                  nbButton 
                  status="basic"
                  type="button"
                  class="mr-2"
                  (click)="onCancel()">
                  <nb-icon icon="close-outline"></nb-icon>
                  {{ 'user_settings.cancel' | translate }}
                </button>
                <button 
                  nbButton 
                  status="success"
                  type="submit"
                  [disabled]="submitted || !form.valid">
                  <nb-icon icon="save-outline"></nb-icon>
                  {{ submitted ? ('user_settings.saving' | translate) : ('user_settings.save_changes' | translate) }}
                </button>
              </div>
            </div>
          </div>
        </form>
      </nb-card-body>
    </nb-card>
  </div>
</div>

